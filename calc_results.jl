using DelimitedFiles
using FLOWMath
using FlowFarm
using CCBlade

nCycles = 50


include("model_lowTI_NEW.jl")
# include("optimized_locs.jl")
nCycles = 50
div_sigma = 2.38512084848453
div_ti = 1.1841406781776536
fos = 2.0
scale = 10.0

# turbine_x = readdlm("FINAL2/x_FINAL2_17.txt")[:,1]
# turbine_y = readdlm("FINAL2/y_FINAL2_17.txt")[:,1]
# turbine_x = readdlm("FINAL2/x_FINAL2_circle_37.txt")[:,1]
# turbine_y = readdlm("FINAL2/y_FINAL2_circle_37.txt")[:,1]

turbine_x = readdlm("x_40_small_26.txt")[:,1]
turbine_y = readdlm("y_40_small_26.txt")[:,1]

# turbine_x = readdlm("x_40_19.txt")[:,1]
# turbine_y = readdlm("y_40_19.txt")[:,1]

# turbine_x = readdlm("x_40_small2_loads_0.09.txt")[:,1]
# turbine_y = readdlm("y_40_small2_loads_0.09.txt")[:,1]

# xopt = [58.325081802084334, 94.46011739448345, 154.76021844985425, 75.8459302875754, 131.79269653649945, -4.56056397789824e-14, 159.9703213696671, -28.783386361131267, 210.4947056208312, 33.51521013086618, 21.902545267095572, -13.768315655609358, 306.4584077273387, 289.5372945505691, -22.75865332904305, 47.18254526709557, 185.25315530402528, 220.13838551592144, 113.09914238888929, -1.5628577518599496, 9.381545459718478, 168.40088595625463, 126.076445057073, 50.56124578089922, 230.3169262262519, 254.07942442103007, 301.26082545175524, 280.0983325899803, 144.02664926458186, 258.82257999704166, 101.13443385598723, 179.92496677988194, 72.4577808619329, 235.54319101773027, -3.43920816351293, 280.1740871116126, 276.55945919549197, 205.20496677988191, 288.18560077699715, 25.27999999999995, 150.50627961897203, 223.200991096687, 233.71123047029943, -0.3052806590842248, 223.12517588385535, -0.33592895027621755, 1.9706667536079245, 236.15805204419888, 0.04919810182885567, 140.98940914462662, 236.15805204419888, 112.78918218607836, -0.3359289502762171, 102.16430728858104, 186.65681958631444, 236.15805204419888, 1.5520218279620275, 116.31373296640484, 206.10217495260042, 42.09933644418592, 133.45828088625518, 161.60089120300225, 3.7875388351401607, -0.20483268472266009, 233.2227670482349, 224.58953946721118, 41.68928672156649, -0.33592895027621805, 21.58938038979805, 13.319805415850404, -0.3359289502762173, 236.15805204419888, 235.65057466355472, 3.4631027862140624, 235.66571013244257, 187.63807301531386, 236.15805204419888, 236.15805204419888, 149.79959733600413, -0.3359289502762177]

# xopt = [-48.40514993336536, 91.39206067401874, 97.92872295529035, 4.171432292093477, -83.19221527825631, 22.902546522334646, -5.059135848516813, -79.97689210464576, -39.82264960489544, -97.38069832967157, -73.07254144576682, 42.45135706488485, 91.80266093339196, -94.12225867470127, 1.1703554112535066, -5.183015420939314, 66.16024368815998, 58.10142426898922, 84.32842156761181, 22.94879504202222, 86.40998842031513, 37.526378674970935, 13.106090788178044, 9.380862502290734, -53.747558694833906, 44.61182882429593, -31.475869296002717, 27.94507205979449, -89.71509208442397, -18.076070243156835, 53.09199508559883, 82.47907689490017, -27.796891317286086, 6.993053617394247, 99.03670101482327, -98.88949716154694, 73.70594827909703, -80.21202650388751, -51.94672239612879, -96.34883215049784]

xopt = [62.38580769581814, 98.57166311030338, 158.01182824948998, 75.84044754767025, 134.66852567626, 1.8175951127877658e-14, 161.87326739294434, -28.783386361131267, 212.4290659013514, 36.496811750122774, 25.016051948872782, -14.172311838720722, 306.4584077273387, 289.15580936001027, -22.403435938139395, 50.29498311495292, 187.1499248801941, 210.9358804029986, 116.46534350120653, -2.3099015659417597, 10.81856087617644, 171.3266454963694, 126.238379964189, 50.56057915638397, 233.55759947208557, 256.1612933797303, 300.9192598956492, 277.33065142800484, 145.24332991727317, 259.4200526977322, 101.12044806325432, 183.27483641821476, 75.57391356137872, 237.0188376024761, -0.26364721787654516, 279.1492253986394, 276.4745540825297, 208.55561323433741, 287.75044386541344, 25.28072396159731, 156.33394554756686, 225.6604580694955, 235.06704054836985, -0.3315668417843519, 225.3445831895616, -0.33592895027621716, 0.16953053291801834, 236.15805204419888, -0.09083506128678073, 145.0155197953662, 236.15805204419888, 116.108550673575, -0.3359289502762171, 106.82353055939883, 183.73823405786817, 235.8547891498854, -0.33592895027621705, 107.77091309407201, 207.79870249096413, 49.50547229343156, 140.31105250552028, 161.98628314380696, 2.538880709763453, -0.21345712228265337, 232.41648073130406, 221.07993124447995, 45.17557221909749, -0.33592895027621805, 19.21214955158209, 17.50488203625375, -0.33592895027621816, 236.15805204419888, 236.1580520441989, 5.782481294308576, 236.01373419347465, 187.1338218738144, 236.15805204419888, 236.1580520441989, 153.37499284668232, -0.3359289502762167]
turbine_x = xopt[1:nturbines].*10.0
turbine_y = xopt[nturbines+1:end].*10.0


AEP_no_loads = ff.calculate_aep(turbine_x, turbine_y, turbine_z, rotor_diameter,
            hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
            cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
            rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11

damage_no_loads = ff.get_total_farm_damage_FINAL(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
        nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)

println("AEP_no_loads: ", AEP_no_loads)
println("damage: ", damage_no_loads)
# damageOpt 40 turbs
# xopt = [322.3804884475346, 132.0302336885437, 428.9569538669368, 324.77684138152784, 187.75277030505143, 244.28446686927725, 67.48444509232638, -31.471183079273644, 423.2152596157513, -9.326301720239682, 25.415027623050296, 176.27934145785403, -7.811199776857034, 251.1019754365447, -5.3850273169076734, 235.18161116027696, 368.8875965603199, 410.3693496118587, 446.49337193066634, 166.86602859996813, 435.16280644044434, 438.9366828892884, 412.50812882853114, 46.29855083632035, 395.16774586327887, 459.6517759535896, 341.8906822852894, 451.3616624034591, -39.649342897792074, 280.53218804861467, 223.4422019530111, 258.2058042488746, 164.220723423184, -37.88662331018175, 99.7918000800026, 103.50089696101699, 329.1406290571886, -11.257141008654216, -22.763121103739486, 8.220062894651225, 245.22667613404408, 225.80260070367808, 244.87667139825757, 354.20946298342545, 199.23197798490406, 87.79149056232814, 256.3510650187224, 258.0739684809345, 298.8708161676266, 120.38930799370044, 354.20946298342545, -0.5038541436463698, 151.39687551997062, 170.1282957171277, 43.74134105198326, -0.5038541436463678, 109.03444422776211, -0.50385414364637, 107.61001793073564, 354.20946298342545, 200.43972967061094, 157.22240225775718, 354.20946298342545, 207.6110938614384, 322.85075177602505, -0.5038541436463693, 34.379155334243364, 57.635758817973034, 354.20946298342545, 354.20946298342545, 354.20946298342545, 243.23742725142102, 73.85048741443175, 310.7853826628461, -0.5038541436463697, 354.20946298342545, -0.5038541436463699, 91.98860169010662, 208.08793797432259, -0.5038541436463713]

# xopt = [-48.40514993336536, 91.39206067401874, 97.92872295529035, 4.171432292093477, -83.19221527825631, 22.902546522334646, -5.059135848516813, -79.97689210464576, -39.82264960489544, -97.38069832967157, -73.07254144576682, 42.45135706488485, 91.80266093339196, -94.12225867470127, 1.1703554112535066, -5.183015420939314, 66.16024368815998, 58.10142426898922, 84.32842156761181, 22.94879504202222, 86.40998842031513, 37.526378674970935, 13.106090788178044, 9.380862502290734, -53.747558694833906, 44.61182882429593, -31.475869296002717, 27.94507205979449, -89.71509208442397, -18.076070243156835, 53.09199508559883, 82.47907689490017, -27.796891317286086, 6.993053617394247, 99.03670101482327, -98.88949716154694, 73.70594827909703, -80.21202650388751, -51.94672239612879, -96.34883215049784]
#
# turbine_x = xopt[1:nturbines].*10.0
# turbine_y = xopt[nturbines+1:end].*10.0
#
# AEP_with_loads = ff.calculate_aep(turbine_x, turbine_y, turbine_z, rotor_diameter,
#             hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
#             cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
#             rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11
#
# damage_with_loads = ff.get_total_farm_damage_FINAL(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
#         nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
#         Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)


# figure(1,figsize=(6.5,2.5))
# subplot(121)
# plot(damage_no_loads,"o",color="C0",markersize=5)
# ylim(0.0,0.32)
# ylabel("damage")
# xlabel("turbine number")
# title("no damage constraints",fontsize=10)
#
# subplot(122)
# plot(damage_with_loads,"o",color="C1",markersize=5)
# ylim(0.0,0.32)
# xlabel("turbine number")
# title("with damage constraints",fontsize=10)
#
# suptitle("20 turbine optimization",fontsize=10)
#
# subplots_adjust(top=0.85,bottom=0.2,left=0.1,right=0.99,wspace=0.25)
#
# savefig("opt_damage_vals20.pdf",transparent=true)




# println("AEP: ", AEP)
# println("damage: ", maximum(damage))


# figure(1,figsize=(3,3))
# plot(damage,"o")
# ylim(0,0.4)
# ylabel("damage")
# xlabel("turbine number")
# tight_layout()
#
#
# figure(2,figsize=(3,3))
# bx = boundary_vertices[:,1]
# append!(bx,bx[1])
# by = boundary_vertices[:,2]
# append!(by,by[1])
# plot(bx,by,"--")
# plot(turbine_x,turbine_y,"o")
# axis("equal")
# axis("off")
# tight_layout()

# hist(aep)







# 40 turbs
# aep40 = [11.591805689429194,11.580138476014413,11.5726879690246,11.572021872185433,11.552006765046045,11.497640149907186]
# ds40 = [0.2506974311777122,0.19987713012579525,0.19023187402230693,0.18018013003850228,0.17177259876909431,0.1624183070395706]
#
#
# # 20 turbs
# aep20 = [5.387686808501937,5.38354819671617,5.3790416588054955,5.357738134080782,5.3203798819588854]
# ds20 = [0.29987273495901184,0.24031434740640276,0.23087593475639218,0.22026756202229664,0.21456207955860523]
#
#
# figure(1,figsize=(6.5,2.))
# subplot(121)
# plot(ds40,aep40./maximum(aep40),"o")
# ylabel("normalized AEP")
# xlabel("maximum turbine damage")
# yticks([0.99,0.995,1.0])
# ylim(0.9852,1.001)
# title("40 turbine optimization",fontsize=10)
#
# subplot(122)
# plot(ds20,aep20./maximum(aep20),"o")
# xlabel("maximum turbine damage")
# yticks([0.99,0.995,1.0])
# ylim(0.9852,1.001)
# tick_params(
#     labelleft=false) # labels along the bottom edge are off
# title("20 turbine optimization",fontsize=10)
#
# subplots_adjust(top=0.9,bottom=0.21,left=0.15,right=0.95,wspace=0.1)
# savefig("damage_aep_paretos.pdf",transparent=true)
