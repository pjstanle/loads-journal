using DelimitedFiles
using FLOWMath
using FlowFarm
using CCBlade

nCycles = 50


include("model_lowTI_NEW.jl")
# include("optimized_locs.jl")
nCycles = 50
div_sigma = 2.38512084848453
div_ti = 1.1841406781776536
fos = 2.0
scale = 10.0

# turbine_x = readdlm("FINAL2/x_FINAL2_17.txt")[:,1]
# turbine_y = readdlm("FINAL2/y_FINAL2_17.txt")[:,1]
# turbine_x = readdlm("FINAL2/x_FINAL2_circle_37.txt")[:,1]
# turbine_y = readdlm("FINAL2/y_FINAL2_circle_37.txt")[:,1]

# turbine_x = readdlm("layout_opt_small/x_40_small_26.txt")[:,1]
# turbine_y = readdlm("layout_opt_small/y_40_small_26.txt")[:,1]
# turbine_x = readdlm("layout_opt_small/x_40_small2_loads_0.09.txt")[:,1]
# turbine_y = readdlm("layout_opt_small/y_40_small2_loads_0.09.txt")[:,1]

# turbine_x = readdlm("x_40_19.txt")[:,1]
# turbine_y = readdlm("y_40_19.txt")[:,1]

# turbine_x = readdlm("x_40_small2_loads_0.09.txt")[:,1]
# turbine_y = readdlm("y_40_small2_loads_0.09.txt")[:,1]

# xopt = [58.325081802084334, 94.46011739448345, 154.76021844985425, 75.8459302875754, 131.79269653649945, -4.56056397789824e-14, 159.9703213696671, -28.783386361131267, 210.4947056208312, 33.51521013086618, 21.902545267095572, -13.768315655609358, 306.4584077273387, 289.5372945505691, -22.75865332904305, 47.18254526709557, 185.25315530402528, 220.13838551592144, 113.09914238888929, -1.5628577518599496, 9.381545459718478, 168.40088595625463, 126.076445057073, 50.56124578089922, 230.3169262262519, 254.07942442103007, 301.26082545175524, 280.0983325899803, 144.02664926458186, 258.82257999704166, 101.13443385598723, 179.92496677988194, 72.4577808619329, 235.54319101773027, -3.43920816351293, 280.1740871116126, 276.55945919549197, 205.20496677988191, 288.18560077699715, 25.27999999999995, 150.50627961897203, 223.200991096687, 233.71123047029943, -0.3052806590842248, 223.12517588385535, -0.33592895027621755, 1.9706667536079245, 236.15805204419888, 0.04919810182885567, 140.98940914462662, 236.15805204419888, 112.78918218607836, -0.3359289502762171, 102.16430728858104, 186.65681958631444, 236.15805204419888, 1.5520218279620275, 116.31373296640484, 206.10217495260042, 42.09933644418592, 133.45828088625518, 161.60089120300225, 3.7875388351401607, -0.20483268472266009, 233.2227670482349, 224.58953946721118, 41.68928672156649, -0.33592895027621805, 21.58938038979805, 13.319805415850404, -0.3359289502762173, 236.15805204419888, 235.65057466355472, 3.4631027862140624, 235.66571013244257, 187.63807301531386, 236.15805204419888, 236.15805204419888, 149.79959733600413, -0.3359289502762177]

# xopt = [-48.40514993336536, 91.39206067401874, 97.92872295529035, 4.171432292093477, -83.19221527825631, 22.902546522334646, -5.059135848516813, -79.97689210464576, -39.82264960489544, -97.38069832967157, -73.07254144576682, 42.45135706488485, 91.80266093339196, -94.12225867470127, 1.1703554112535066, -5.183015420939314, 66.16024368815998, 58.10142426898922, 84.32842156761181, 22.94879504202222, 86.40998842031513, 37.526378674970935, 13.106090788178044, 9.380862502290734, -53.747558694833906, 44.61182882429593, -31.475869296002717, 27.94507205979449, -89.71509208442397, -18.076070243156835, 53.09199508559883, 82.47907689490017, -27.796891317286086, 6.993053617394247, 99.03670101482327, -98.88949716154694, 73.70594827909703, -80.21202650388751, -51.94672239612879, -96.34883215049784]

xopt = [81.33684672480761, 99.47152159661727, 160.43516034977569, 80.98837367566927, 136.3521313525065, 8.88834360837494, 157.2840386980597, -16.264209098328433, 207.65769454922625, 42.5832823512861, 27.30421824102543, -13.160589671654279, 305.00731444898986, 280.4186751511217, -5.090021214266057, 51.6100297052523, 181.03852541857142, 240.34617639068196, 108.45855564409482, -4.284453732320367, 17.038533961180153, 181.10124883479958, 127.39204179459661, 55.708304181443594, 235.21767540979002, 256.89538781205613, 300.45328368564054, 276.3241353393352, 147.23187745177134, 258.0475062914471, 105.45553044197939, 185.3731499309967, 76.18769190680531, 232.96870596246657, 2.998406799359009, 267.8348143873835, 278.4543997630826, 210.5799000127878, 287.00772311948805, 34.16844159406057, 139.6439920953414, 215.83204316428743, 228.83312874825148, -0.33592895027621733, 221.12586791117025, 13.289838661922714, 12.491397020729393, 219.78481797920315, 9.000210248006804, 114.26301466694943, 229.19853152722445, 107.79590114902139, -0.33592895027621816, 83.16810995818952, 159.9890057939912, 236.1580520441989, 3.842455229563952, 108.04913903782656, 192.1987384616006, 34.866583597425524, 107.45014306321198, 137.8806142158751, 18.590400257707213, -0.33592895027621716, 229.53374270764854, 216.52617318915867, 49.00418944887772, -0.33592895027621694, 42.34332834896017, 21.08818665500041, 6.023949983293198, 233.0673830588976, 230.2115820335686, 24.421592396966794, 236.15805204419888, 173.86051780156802, 229.7544170630487, 235.1960974707495, 157.36114577726394, 12.906349674229006]
turbine_x = xopt[1:nturbines].*10.0
turbine_y = xopt[nturbines+1:end].*10.0

AEP_no_loads = ff.calculate_aep(turbine_x, turbine_y, turbine_z, rotor_diameter,
            hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
            cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
            rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11

damage_no_loads = ff.get_total_farm_damage_FINAL(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
        nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)

println("AEP: ", AEP_no_loads/11.290610570223455)
println("damage: ", maximum(damage_no_loads./0.10346480557909844))

# println("AEP_no_loads: ", AEP_no_loads)
# println("damage: ", damage_no_loads)
# damageOpt 40 turbs
# xopt = [74.62835790467558, 96.24487360835423, 154.7390380148238, 76.940120391648, 131.9001110349114, 7.5667210651691015, 151.74988867010538, -17.85328197655721, 202.77060877173366, 40.06032358580818, 24.580669806621884, -13.394261340750733, 306.28011108954684, 281.13987710207437, -6.506282922824992, 48.88510998506487, 177.33216011729903, 234.36390715738028, 104.67425552205279, -4.842729645856914, 15.260485666866897, 177.90286509931195, 125.84327335687206, 51.66012581500048, 229.98519383201642, 252.58016081392057, 300.24154512979237, 267.5044232270395, 142.80373110066586, 254.7867708699692, 102.09290672799364, 180.0127491219712, 73.86268755539163, 228.25472935359338, 0.27618724255419136, 274.0713173326423, 277.2488586717766, 205.19959991664967, 287.3501981983801, 32.83168280268644, 137.45513420315154, 220.50686848427185, 232.24031231608717, -0.3359289502762173, 221.40099187740734, 17.429619625529398, 12.79878390786671, 218.5398584315955, 2.876443120182572, 115.52248993918344, 229.2030115975768, 109.71582615634672, 0.2837624682797359, 95.69611664336172, 164.43724734138524, 236.15805204419888, 5.933790834115881, 108.98960170090179, 196.6730290124586, 39.454240694783714, 110.02290185361244, 141.59853334245713, 18.187550731409768, -0.3193694879668013, 229.99711944470116, 218.6465542486473, 48.74710092161503, -0.33592895027621805, 38.72101090898128, 25.584498039534584, 2.1982844454135564, 232.80416442076273, 232.25938168992067, 18.456910105522955, 236.15805204419888, 180.22036512714243, 235.78739941685555, 234.97233153165521, 156.53782452488002, 16.557777378256162]
# turbine_x = xopt[1:nturbines].*10.0
# turbine_y = xopt[nturbines+1:end].*10.0
#
# AEP_with_loads = ff.calculate_aep(turbine_x, turbine_y, turbine_z, rotor_diameter,
#             hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
#             cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
#             rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11
#
# damage_with_loads = ff.get_total_farm_damage_FINAL(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
#         nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
#         Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)


# figure(1,figsize=(6.5,2.5))
# subplot(121)
# plot(damage_no_loads./0.10346480557909844,"o",color="C0",markersize=5)
# ylim(0.0,1.03)
# ylabel("normalized damage")
# xlabel("turbine number")
# title("no damage constraints",fontsize=10)
#
# subplot(122)
# plot(damage_with_loads./0.10346480557909844,"o",color="C1",markersize=5)
# ylim(0.0,1.03)
# xlabel("turbine number")
# title("with damage constraints",fontsize=10)
#
# # suptitle("20 turbine optimization",fontsize=10)
#
# subplots_adjust(top=0.9,bottom=0.2,left=0.12,right=0.99,wspace=0.25)
#
# savefig("opt_damage_vals0.7.pdf",transparent=true)




# println("AEP: ", AEP)
# println("damage: ", maximum(damage))
#
#
# figure(1,figsize=(3,3))
# plot(damage,"o")
# ylim(0,0.4)
# ylabel("damage")
# xlabel("turbine number")
# tight_layout()
#
#
# figure(2,figsize=(3,3))
# bx = boundary_vertices[:,1]
# append!(bx,bx[1])
# by = boundary_vertices[:,2]
# append!(by,by[1])
# plot(bx,by,"--")
# plot(turbine_x,turbine_y,"o")
# axis("equal")
# axis("off")
# tight_layout()

# hist(aep)







# 40 turbs
# aep40 = [11.591805689429194,11.580138476014413,11.5726879690246,11.572021872185433,11.552006765046045,11.497640149907186]
# ds40 = [0.2506974311777122,0.19987713012579525,0.19023187402230693,0.18018013003850228,0.17177259876909431,0.1624183070395706]
#
#
# # 20 turbs
# aep20 = [5.387686808501937,5.38354819671617,5.3790416588054955,5.357738134080782,5.3203798819588854]
# ds20 = [0.29987273495901184,0.24031434740640276,0.23087593475639218,0.22026756202229664,0.21456207955860523]
#
#
# figure(1,figsize=(6.5,2.))
# subplot(121)
# plot(ds40,aep40./maximum(aep40),"o")
# ylabel("normalized AEP")
# xlabel("maximum turbine damage")
# yticks([0.99,0.995,1.0])
# ylim(0.9852,1.001)
# title("40 turbine optimization",fontsize=10)
#
# subplot(122)
# plot(ds20,aep20./maximum(aep20),"o")
# xlabel("maximum turbine damage")
# yticks([0.99,0.995,1.0])
# ylim(0.9852,1.001)
# tick_params(
#     labelleft=false) # labels along the bottom edge are off
# title("20 turbine optimization",fontsize=10)
#
# subplots_adjust(top=0.9,bottom=0.21,left=0.15,right=0.95,wspace=0.1)
# savefig("damage_aep_paretos.pdf",transparent=true)
