using Snopt
import ForwardDiff

function vel_wrapper(x)

    global wec_factor
    global wakedeflectionmodel
    global wakecombinationmodel
    global rotor_diameter
    global hub_height
    global turbine_x
    global turbine_y
    global turbine_z
    global turbine_yaw
    global turbine_ct
    global turbine_ai
    global turbine_local_ti
    global sorted_turbine_index
    global wtvelocities
    global wind_resource
    global model_set

    global sweep

    global scale_a
    global scale_b
    global scale_1
    global scale_2
    global data_array

    alpha_star = x[1]*scale_a
    beta_star = x[2]*scale_b
    k1 = x[3]*scale_1
    k2 = x[4]*scale_2

    wakedeficitmodel = ff.GaussYawVariableSpread(alpha_star, beta_star, k1, k2, wec_factor)
    local_ti_model = ff.LocalTIModelMaxTI(alpha_star, beta_star, k1, k2)
    model_set = ff.WindFarmModelSet(wakedeficitmodel,wakedeflectionmodel,wakecombinationmodel,local_ti_model)


    # sep = [4.0,7.0,10.0]
    # ti = [0.046,0.046,0.046]
    sep = [4.0,7.0,10.0,4.0,7.0,10.0]
    ti = [0.046,0.046,0.046,0.08,0.08,0.08]

    vel_points = zeros(typeof(k1),length(sweep)*length(sep))
    index = 1
    for i = 1:length(sep)
        ambient_ti = [ti[i]]
        turbine_local_ti = copy(ambient_ti)
        turbine_local_ti = ff.calculate_local_ti(turbine_x, turbine_y, ambient_ti, rotor_diameter, hub_height, turbine_yaw, turbine_local_ti, sorted_turbine_index,
                            turbine_inflow_velcities, turbine_ct, local_ti_model)
        for j = 1:length(sweep)
            loc = [sep[i]*rotor_diameter[1],sweep[j],hub_height[1]]
            vel_points[index] = ff.point_velocity(loc, turbine_x, turbine_y, turbine_z, turbine_yaw, turbine_ct, turbine_ai,
                            rotor_diameter, hub_height, turbine_local_ti, sorted_turbine_index, turbine_inflow_velcities,
                            windresource, model_set)
            index += 1
        end
    end
    return [sum((vel_points .- data_array) .^2)]./1.0
end


function params_opt(x)
    vels = vel_wrapper(x)
    dvels_dx = ForwardDiff.jacobian(vel_wrapper,x)

    c = []
    dcdx = []

    fail = false
    return vels[1], c, dvels_dx, dcdx, fail
end


global wec_factor
global wakedeflectionmodel
global wakecombinationmodel
global rotor_diameter
global hub_height
global turbine_x
global turbine_y
global turbine_z
global turbine_yaw
global turbine_ct
global turbine_ai
global turbine_local_ti
global sorted_turbine_index
global wtvelocities
global wind_resource
global model_set

global sweep

global data_array


"""low TI"""
U4low = [10.982978327876998, 11.004565254126359, 11.02585783171067, 11.0485931928388, 11.07293170856613, 11.098683812946877, 11.107096103304562, 11.114810930745993, 11.117501637985704, 11.106158479196445, 11.094366816526968, 11.087193031729242, 11.08162894017074, 11.076376509839175, 11.0805527115551, 11.084841444224137, 11.08418491768436, 11.077501659776516, 11.07242597963307, 11.048296430697608, 11.022473359578475, 10.994272368235327, 10.958245603237657, 10.92386333306891, 10.863791672220483, 10.790962149465576, 10.718218466338252, 10.545334594882348, 10.37277522510844, 10.162618255645983, 9.89082089624214, 9.627020910321509, 9.320701310755034, 9.00973584970292, 8.701191222508156, 8.387219708214602, 8.070814949842987, 7.816140073174736, 7.600198652545017, 7.3772795002138265, 7.303023677875945, 7.229267533650562, 7.177111088638997, 7.173617205948367, 7.1649306193958715, 7.177580425711747, 7.1943645536702325, 7.20621135338884, 7.194350272555969, 7.183280362271231, 7.143900314520721, 7.08087996612525, 7.019486659577743, 6.9620499162140375, 6.906193888628875, 6.8743317744389145, 6.898780526637663, 6.9172506779389, 7.01773337710016, 7.143655223668076, 7.277226297650731, 7.517929698732475, 7.757795534362021, 8.036858363160428, 8.360678660936529, 8.679388512763897, 9.02229732866094, 9.365490580638745, 9.693605395435597, 9.980311002864987, 10.271900506842826, 10.477440257406716, 10.645889091679464, 10.812887985830075, 10.904676094297525, 10.99690551715319, 11.071280912207252, 11.117523940908388, 11.167927358781617, 11.184782054044282, 11.197438025025264, 11.20934837764427, 11.215761451028737, 11.222241773289012, 11.229319737728025, 11.236709934848285, 11.244282268212542, 11.246629622800532, 11.248947502102435, 11.250874215083567, 11.251882352238887, 11.252608147951156, 11.254995589885876, 11.257678646745966, 11.260111976661886, 11.262598001584422, 11.264788008988006, 11.26770481651768, 11.27143331898097, 11.27520598149523]

U7low = [10.955507520692134, 10.965821342361288, 10.975777400755439, 10.9933877511089, 11.017931190154837, 11.04285337723238, 11.060095066495162, 11.077028879727829, 11.089198785343946, 11.077329736245407, 11.068035862253536, 11.057888704763922, 11.047379267747127, 11.037506112260575, 11.03770231801364, 11.038025542486613, 11.032229641023644, 11.018911811817098, 11.007096093591727, 10.977287115047147, 10.946124526786058, 10.91099538542324, 10.86211340488067, 10.815884628503028, 10.737150450180248, 10.643129779420416, 10.549275286247509, 10.41529254462774, 10.281277113054887, 10.1476659740456, 10.013374184280838, 9.881865372484432, 9.729116944984895, 9.57324740659505, 9.4137260179213, 9.223905931500775, 9.034087700607289, 8.85289728631355, 8.674779223707946, 8.495602159828323, 8.352529414509654, 8.20988156595644, 8.077139793802978, 7.966088520037428, 7.852158811240493, 7.7637358900076565, 7.68073344595924, 7.601637802694947, 7.555737058965987, 7.509260537260738, 7.485451236627247, 7.484935303458281, 7.480535688837448, 7.518081889654293, 7.557142847033806, 7.609488878618345, 7.698625384956711, 7.784336449987527, 7.903214132239573, 8.032463093553439, 8.16410350537304, 8.3525086405383, 8.540223835498349, 8.747753332422942, 8.980334827372682, 9.215044542026213, 9.423427849083625, 9.629792776136286, 9.827196258880772, 9.99655991209825, 10.167635024367017, 10.314517702733776, 10.451640261404743, 10.588232994260089, 10.686435687224508, 10.784738260949537, 10.866807772602991, 10.924922743936666, 10.985381591879253, 11.020098294820324, 11.051554155489534, 11.08205494422274, 11.107197077475, 11.13264856929372, 11.155345685385008, 11.176133834773161, 11.19756660785888, 11.201562308185265, 11.205397888048031, 11.205827599721037, 11.199554608631411, 11.193519781075317, 11.185313871416563, 11.176693884573975, 11.16883977730857, 11.167273381133905, 11.165485223639118, 11.168179962379337, 11.17443308908145, 11.18043648651415]

U10low = [10.943638405497524, 10.950903797357892, 10.958901180234806, 10.96964431308455, 10.983728651871827, 10.997639926470224, 11.008159242199726, 11.018224262868143, 11.025754542883742, 11.020401795296747, 11.01635349749996, 11.013004547284279, 11.010013643968943, 11.006946121220999, 10.993367948768027, 10.98022449974791, 10.959963942505054, 10.927861221066838, 10.896604394574211, 10.869046651736287, 10.84224989714536, 10.813879302723546, 10.772883625342041, 10.733134758884237, 10.670240641487057, 10.592091929631595, 10.514054163778843, 10.42606113602971, 10.338028702552844, 10.249547180975728, 10.16002469247852, 10.070591597349333, 9.982075424298767, 9.893827770049771, 9.805890950185699, 9.722327572099351, 9.638371245879833, 9.541884422539574, 9.434470105622593, 9.32735036762716, 9.207902044886215, 9.087710609598094, 8.966668800789575, 8.842826526635585, 8.719252285044892, 8.622073211502046, 8.535106544176744, 8.4498156096221, 8.415285534770925, 8.377046011233483, 8.350725431831876, 8.338413264326048, 8.325412149726263, 8.353250831015625, 8.386189861915895, 8.42797009192387, 8.512546881806257, 8.592799300077827, 8.688582063167669, 8.792095519918295, 8.895802153961691, 9.020575842913905, 9.1443921876256, 9.270265263623687, 9.399428010004241, 9.52836249834557, 9.64678392233307, 9.763136716503613, 9.88126103406023, 10.012784304384082, 10.142971956437961, 10.265339659396197, 10.382708633315788, 10.500103929424617, 10.574230050115041, 10.648481896701494, 10.715189338258376, 10.765152621690943, 10.816541859206723, 10.855289346259067, 10.890495288771668, 10.925215294809478, 10.953591182915115, 10.982548402611311, 11.009102650713476, 11.033617011024068, 11.058180395425897, 11.062686723946214, 11.066117974437224, 11.068044257862013, 11.065240094424443, 11.0628892805124, 11.064539398205916, 11.06768746437068, 11.070819606639551, 11.07351811624454, 11.076249011788116, 11.081542049139507, 11.089735303663122, 11.097792612185707]

"""high TI"""
U4high = [11.50666143302813, 11.514960409337359, 11.523124867585203, 11.528562586011349, 11.531890546767158, 11.535486692847345, 11.530444631571727, 11.524726650106317, 11.5167721094315, 11.501826117132435, 11.486739197407312, 11.475232946860869, 11.464800898874381, 11.453823298009075, 11.438263757435237, 11.422439495726891, 11.402480522609844, 11.378129571315293, 11.352929547043619, 11.330913258927458, 11.309035587475305, 11.286045817894967, 11.260046674780655, 11.235956321408041, 11.183401044597765, 11.116351952562923, 11.048824804623067, 10.94622974083278, 10.844134621203372, 10.731599446974018, 10.601448867569804, 10.480634560912549, 10.30660419919301, 10.12601615364266, 9.946929662125424, 9.763583113017305, 9.580150558435113, 9.408607955507954, 9.24421207926673, 9.0790095661407, 8.941400714476666, 8.804549163443447, 8.672508639402336, 8.554548299601434, 8.436519532016694, 8.322196734169472, 8.209047521656851, 8.102774542909394, 8.040474173906622, 7.976609030824823, 7.940451061681494, 7.928808264909083, 7.912214097417763, 7.93294776725613, 7.954900349176535, 7.9834670873971705, 8.030991095081806, 8.075148454657214, 8.148893603337948, 8.231831019727823, 8.317365581961838, 8.462321963055688, 8.605778130180475, 8.766948335181, 8.949264496685554, 9.126567293853915, 9.321930324025626, 9.517973453001307, 9.710532938095813, 9.8963881277756, 10.083350843561663, 10.254919008479517, 10.419642639056997, 10.58332424689289, 10.72177702366458, 10.859897080391297, 10.974871252162949, 11.054915289492941, 11.13772276005664, 11.178500667852674, 11.21166772652081, 11.240142755892723, 11.242498719380402, 11.24619088346991, 11.233707595914039, 11.210830635301956, 11.187735842784305, 11.177758427490051, 11.168807080487797, 11.170400282571991, 11.190889981746743, 11.212435836088153, 11.229798931183225, 11.245979552410335, 11.259632914543653, 11.26116472037371, 11.26259407052415, 11.265004891261514, 11.268397555267063, 11.270648420622363]

U7high = [11.532324830379599, 11.54065639240156, 11.548988163974679, 11.55529972685878, 11.560565345060574, 11.5662191420509, 11.564091452766531, 11.561688785209455, 11.558510246363824, 11.55339634801304, 11.549296439506884, 11.533174405634666, 11.51329431717491, 11.492734911308114, 11.455181115579162, 11.417785553417591, 11.384264545011288, 11.35470632104516, 11.325671614775963, 11.292123943817593, 11.258165766510553, 11.222956359841726, 11.184545111421018, 11.146780883948926, 11.101425663718354, 11.052450205774031, 11.003844786978423, 10.932010915667375, 10.860134670128506, 10.796837438210542, 10.74656835229847, 10.699913546573054, 10.618683058893817, 10.532427529502373, 10.438016747538061, 10.299943154718154, 10.161111673918871, 10.034458220890816, 9.915866731420598, 9.796363388012967, 9.701238210507196, 9.606426446332566, 9.505790468670142, 9.390896828039134, 9.274556499381042, 9.18167268224236, 9.093272717964423, 9.013083926276499, 8.983458095362549, 8.953562730576959, 8.930832293010365, 8.913537554554434, 8.893371756288374, 8.901692489092838, 8.91102948351308, 8.925326315873923, 8.956199381049895, 8.985478713958887, 9.030789565360323, 9.081263474462341, 9.132631225683916, 9.202546526918766, 9.272329262257212, 9.346826098869258, 9.426954864956418, 9.506606005309889, 9.616422712869108, 9.731585592472028, 9.844873097038898, 9.960087813946641, 10.075752921999872, 10.177227791185363, 10.274026306015914, 10.370382378271099, 10.483390421148727, 10.596488720315627, 10.692929500293053, 10.763283135426537, 10.836254315350008, 10.883206887499364, 10.926678945993658, 10.968899091751418, 11.00538337707754, 11.043118234600737, 11.065545083798964, 11.078319690710066, 11.091843746217277, 11.102697527763148, 11.11351471082931, 11.130499540585783, 11.158190667643433, 11.184337755524128, 11.224741892651547, 11.268045698692054, 11.308918218153588, 11.334188726986069, 11.360266127879418, 11.371347467697559, 11.369942834514946, 11.368144159315603]

U10high = [11.620883825904931, 11.60232257287173, 11.583952053301317, 11.56430984861988, 11.543112524189839, 11.521995040063832, 11.498145152306762, 11.473931647277704, 11.45292769307036, 11.448238674906147, 11.441898707762942, 11.439838970268942, 11.43997516914753, 11.44001165038807, 11.426378066901368, 11.413310456982469, 11.390136235120252, 11.350153126639754, 11.311372026236187, 11.270610296832222, 11.22944064661717, 11.190626597875216, 11.170683005498077, 11.148865934993111, 11.120996291746877, 11.08913120847682, 11.05729510195932, 10.997558158535968, 10.937726371885574, 10.876144564404289, 10.810532648638098, 10.745270540237442, 10.684055211708634, 10.62400910478716, 10.564379267440126, 10.510601361445923, 10.456295887534276, 10.394080301251384, 10.324953083344239, 10.256011307621664, 10.195270829216177, 10.135038274521557, 10.082677616901087, 10.056164098734875, 10.027153217449019, 9.981536166311553, 9.929499126890303, 9.877229145098035, 9.817921905686623, 9.759140020897597, 9.711337612299923, 9.676424831794725, 9.640876698995886, 9.632134291158934, 9.626746614562302, 9.626383392756141, 9.650341394792566, 9.671842106089745, 9.69381978139203, 9.716030454387854, 9.738431768655978, 9.78164072233991, 9.823897867746183, 9.876162512366033, 9.94446679120507, 10.011659021715667, 10.081495202641753, 10.15184775188019, 10.221437374838581, 10.285263590457653, 10.349667498911167, 10.4023268446955, 10.447479407184034, 10.492673297989809, 10.531426053387026, 10.570196943963307, 10.609343320266357, 10.649317665886633, 10.68922027962836, 10.737500758816818, 10.788131603569772, 10.83898702915404, 10.892771152036014, 10.946285179197439, 10.989391316110293, 11.02372540465431, 11.058273008356736, 11.089603886129286, 11.120758056773948, 11.151054959823517, 11.178667216442877, 11.206535140226418, 11.225062903104673, 11.240092327289233, 11.2553125406195, 11.275731808541623, 11.295762346266535, 11.315203828993935, 11.333978063293463, 11.352783397846697]


place = 1
sweep = range(-200.0,stop=200.0,length=length(U4low))[place:end]

data_array = [U4low[place:end];U7low[place:end];U10low[place:end];U4high[place:end];U7high[place:end];U10high[place:end]]
# data_array = [U4low[place:end];U7low[place:end];U10low[place:end]]

include("model_optParams.jl")
x = [copy(alpha_star);copy(beta_star);copy(k1);copy(k2)]

x = rand(4) .* [5.0,1.0,1.0,0.01]
# x = [5.0,0.5,0.3837,0.003678]

scale_a = 1.0
scale_b = 1.0
scale_1 = 1.0
scale_2 = 1.0

x[1] /= scale_a
x[2] /= scale_b
x[3] /= scale_1
x[4] /= scale_2

println("start: ", vel_wrapper(x))

lb = zeros(4) .+ 0.000
ub = zeros(4) .+ 10.0
options = Dict{String, Any}()
options["Derivative option"] = 1
options["Verify level"] = 3
options["Major optimality tolerance"] = 1e-6
options["Major iteration limit"] = 1e6
options["Summary file"] = "snopt-summary.out"
options["Print file"] = "snopt-print.out"

t1 = time()
xopt, fopt, info = snopt(params_opt, x, lb, ub, options)
println("Finished: ", time()-t1)

println("xopt: ", xopt)
println("fopt: ", fopt)
println("info: ", info)

plot(data_array)





alpha_star = xopt[1]*scale_a
beta_star = xopt[2]*scale_b
k1 = xopt[3]*scale_1
k2 = xopt[4]*scale_2

wakedeficitmodel = ff.GaussYawVariableSpread(alpha_star, beta_star, k1, k2, wec_factor)
local_ti_model = ff.LocalTIModelMaxTI(alpha_star, beta_star, k1, k2)
model_set = ff.WindFarmModelSet(wakedeficitmodel,wakedeflectionmodel,wakecombinationmodel,local_ti_model)

# sep = [4.0,7.0,10.0]
# ti = [0.046,0.046,0.046]
sep = [4.0,7.0,10.0,4.0,7.0,10.0]
ti = [0.046,0.046,0.046,0.08,0.08,0.08]

vel_points = zeros(typeof(k1),length(sweep)*length(sep))
global index = 1
for i = 1:length(sep)
    ambient_ti = [ti[i]]
    turbine_local_ti = copy(ambient_ti)
    turbine_local_ti = ff.calculate_local_ti(turbine_x, turbine_y, ambient_ti, rotor_diameter, hub_height, turbine_yaw, turbine_local_ti, sorted_turbine_index,
                        turbine_inflow_velcities, turbine_ct, local_ti_model)
    for j = 1:length(sweep)
        global index
        loc = [sep[i]*rotor_diameter[1],sweep[j],hub_height[1]]
        vel_points[index] = ff.point_velocity(loc, turbine_x, turbine_y, turbine_z, turbine_yaw, turbine_ct, turbine_ai,
                        rotor_diameter, hub_height, turbine_local_ti, sorted_turbine_index, turbine_inflow_velcities,
                        windresource, model_set)
        index += 1
    end
end

plot(vel_points)
