using FLOWMath
using Geodesy
using FlowFarm
const ff = FlowFarm
using CCBlade
using PyPlot
using Random

include("vel_data.jl")
include("TI_data.jl")


function SOWFA_damage(turbine_y,nCycles,az_arr,turb_samples,pitch_func,turbulence_func,U_func,
    r,sections,Rhub,Rtip,precone,tilt;Nlocs=20,fos=1.15)


        hub_height = 90.0
        rotor_diameter = 126.4
        B = 3
        air_density = 1.225

        naz = length(az_arr)

        flap = zeros(nCycles*naz)
        edge = zeros(nCycles*naz)
        oms = zeros(nCycles*naz)
        p_arr = zeros(nCycles*naz)
        TI_inst_arr = zeros(length(az_arr))

        for i = 1:naz
            az = az_arr[i]
            TI_arr = zeros(length(r))
            for k = 1:length(r)
                TI_arr[k] = turbulence_func(turbine_y)
            end

            TI_inst = 0.0
            for k = 1:length(r)
                if k == length(r)
                    TI_inst += (Rtip-r[end])*TI_arr[end]/Rtip
                else
                    TI_inst += (r[k+1]-r[k])*TI_arr[k]/Rtip
                end
            end
            TI_inst_arr[i] = TI_inst
        end

        eff_TI = sum(TI_inst_arr)/length(TI_inst_arr)


        x_locs, y_locs, z_locs = ff.find_xyz_simple(0.0,turbine_y,hub_height,r,0.0,az_arr[1])
        U1 = U_func.(y_locs)

        x_locs, y_locs, z_locs = ff.find_xyz_simple(0.0,turbine_y,hub_height,r,0.0,az_arr[2])
        U2 = U_func.(y_locs)

        turbine_velocity = (sum(U1) + sum(U2))/(2*length(U1))

        # Omega = 7.571322070955497*turbine_velocity/(rotor_diameter/2.0)
        # if Omega > 1.365713158368555
        #     Omega = 1.365713158368555
        # end
        Omega = 7.024674652947367*turbine_velocity/(rotor_diameter/2.0)
        if Omega > 1.2671090354999999
            Omega = 1.2671090354999999
        end

        pitch_deg = pitch_func(turbine_velocity) #in degrees
        pitch = pitch_deg*3.1415926535897/180.0 #convert to rad
        # pitch = 0.

        m_arr_flap = zeros(length(az_arr))
        m_arr_edge = zeros(length(az_arr))
        U_avg = zeros(length(az_arr))
        for i = 1:length(az_arr)
            az = az_arr[i]
            x_locs, y_locs, z_locs = ff.find_xyz_simple(0.0,turbine_y,hub_height,r,0.0,az)
            U = U_func.(y_locs)
            rotor = CCBlade.Rotor(Rhub, Rtip, B, true, pitch, precone)
            op = ff.distributed_velocity_op.(U, Omega, r, precone, 0.0, tilt, az, air_density)

            out = CCBlade.solve.(Ref(rotor), sections, op)

            """testing the correct theta"""
            m_arr_flap[i],m_arr_edge[i] = ff.get_moments_twist(out,Rhub,Rtip,r,az,precone,tilt,rotor,sections)
            U_avg[i] = trapz(r.^2,U)/(maximum(r)^2)
        end

        m_arr_flap_0 = zeros(length(az_arr))
        m_arr_edge_0 = zeros(length(az_arr))

        for i = 1:length(az_arr)
            az = az_arr[i]
            rotor = CCBlade.Rotor(Rhub, Rtip, B, true, pitch, precone)
            U = ones(length(r)).*11.4
            op = ff.distributed_velocity_op.(U, Omega, r, precone, 0.0, tilt, az, air_density)
            out = CCBlade.solve.(Ref(rotor), sections, op)

            m_arr_flap_0[i],m_arr_edge_0[i] = ff.get_moments(out,Rhub,Rtip,r,az,precone,tilt)
        end


        for i = 1:nCycles*naz
            az = az_arr[(i+1)%naz+1]

            TI_inst = TI_inst_arr[(i+1)%naz+1]
            # TI_inst = 0.046
            # TI_inst = 0.08

            turbine_velocity_with_turb = turbine_velocity + turb_samples[i]*eff_TI*turbine_velocity
            # Omega = 7.571322070955497*turbine_velocity_with_turb/(rotor_diameter/2.0)
            Omega = 7.024674652947367*turbine_velocity_with_turb/(rotor_diameter/2.0)
            # if Omega > 1.365713158368555
            #     Omega = 1.365713158368555
            # end
            if Omega > 1.2671090354999999
                Omega = 1.2671090354999999
            end

            blade_mass=17536.617
            blade_cm=20.650
            grav=9.81

            pitch_deg = pitch_func(turbine_velocity_with_turb) #in degrees
            pitch_inst = pitch_deg*3.1415926535897/180.0 #convert to rad
            pitch_diff = pitch_inst-pitch
            # pitch_diff = 0.0
            # pitch_curr = copy(pitch_next)
            # pitch_diff = pitch_curr-pitch
            # pitch_deg = pitch_func(turbine_velocity_with_turb) #in degrees
            # pitch_next = pitch_deg*3.1415926535897/180.0 #convert to rad


            power = 1.285
            if turb_samples[i]*TI_inst > -1.0
                TI_val = (1.0 + turb_samples[i]*TI_inst)^power
            else
                TI_val = (1.0 + turb_samples[i]*TI_inst)^power
            end
            if -pitch_diff < pitch
                flap[i] = m_arr_flap[(i+1)%naz+1] * TI_val - (47274.80916030534)*pitch_diff
            else
                flap[i] = m_arr_flap[(i+1)%naz+1] * TI_val - (47274.80916030534)*(-pitch)
            end
            aero_edge = m_arr_edge[(i+1)%naz+1] - sin(az)*cos(precone)*cos(tilt)*blade_mass*grav*blade_cm/1000.0
            aero_edge = aero_edge * TI_val + sin(az)*cos(precone)*cos(tilt)*blade_mass*grav*blade_cm/1000.0

            if pitch_diff > 0.0
                n = 280
                m = 0.05
                edge[i] = aero_edge - ((pitch_diff-m)*n)^2
            elseif pitch_diff < 0.0 && pitch_diff > -pitch
                n = 280
                m = 0.05
                edge[i] = aero_edge + ((pitch_diff-m)*n)^2
            elseif pitch_diff < -pitch
                n = 280
                m = 0.05
                edge[i] = aero_edge + ((pitch-m)*n)^2
            else
                edge[i] = aero_edge
            end

            oms[i] = Omega

        end

        # figure(figsize=(6,6))
        # plot(flap)
        # plot(edge)
        # ylim(-4000,12000)

        # println("plotting")
        # plot(p_arr)

        xlocs = zeros(Nlocs)
        ylocs = zeros(Nlocs)
        angles = range(-3.1415926535897/2.0,stop=3.1415926535897/2.0,length=Nlocs)
        root_rad=3.542/2.0
        for i in 1:Nlocs
            xlocs[i] = cos(angles[i])*root_rad
            ylocs[i] = sin(angles[i])*root_rad
        end

        avg_omega = sum(oms)/length(oms)
        total_time = (nCycles)/(avg_omega/(2.0*3.1415926535897))

        d_arr = zeros(Nlocs)
        damage = 0.0
        ind = 0
        for i  = 1:Nlocs
            sigma = ff.calc_moment_stress.(edge,flap,xlocs[i],ylocs[i])
            peaks = ff.get_peaks(sigma)
            out = ff.rainflow(peaks)

            alternate = out[1,:]/2.
            mean = out[2,:]
            count = out[3,:]

            su = 70000.0
            m = 10.0
            years = 25.0
            freq = 1.0

            mar = alternate./(1.0.-mean./su)

            npts = length(mar)
            #damage calculations
            d = 0.0
            for i = 1:npts
                Nfail = ((su)/(mar[i]*fos))^m
                mult = years*365.25*24.0*3600.0*freq/total_time
                d += count[i]*mult/Nfail
            end
            d_arr[i] = d
            if d > damage
                damage = d
                ind = i
            end
        end
        return damage
end

wind_speed = 10.0
include("model.jl")



Nlocs = 50
# az_arr = [0.0,pi/2,pi,3*pi/2]
az_arr = [pi/2,3*pi/2]
naz = length(az_arr)

turb_samples_high = [ 3.41739490e+00,  3.65949079e+00,  3.79506449e+00,  3.62075545e+00,        3.20435052e+00,  2.75889408e+00,  2.36185682e+00,  1.94545190e+00,
        1.56778231e+00,  1.43220861e+00,  1.53873080e+00,  1.72272368e+00,        1.80987820e+00,  1.82924587e+00,  1.96481957e+00,  2.12944477e+00,
        1.99387107e+00,  1.48062779e+00,  9.48016835e-01,  7.34972453e-01,        8.99597657e-01,  1.19011272e+00,  1.32568642e+00,  1.22884807e+00,
        9.96436012e-01,  7.25288617e-01,  4.44457386e-01,  1.82993826e-01,        8.68478651e-03, -9.99049034e-04,  1.05523142e-01,  2.60464511e-01,
        3.28251360e-01,  2.89516017e-01,  2.12045333e-01,  1.34574649e-01,       -3.00505557e-02, -3.10881787e-01, -6.01396853e-01, -7.36970551e-01,
       -6.98235208e-01, -5.62661511e-01, -4.27087813e-01, -3.98036306e-01,       -5.23926169e-01, -7.56338222e-01, -9.69382604e-01, -1.08558863e+00,
       -1.12432397e+00, -1.14369164e+00, -1.20857334e+00, -1.28313888e+00,       -1.30831685e+00, -1.22794101e+00, -1.05653712e+00, -8.43492742e-01,
       -6.88551373e-01, -6.01396853e-01, -5.43293840e-01, -4.17403978e-01,       -2.23727267e-01, -1.06828846e-02,  1.53942320e-01,  3.28251360e-01,
        5.80031084e-01,  8.12443137e-01,  8.80229986e-01,  7.83391630e-01,        6.86553275e-01,  7.34972453e-01,  8.51178479e-01,  8.99597657e-01,
        9.18965328e-01,  9.86752177e-01,  1.09327437e+00,  1.11264204e+00,        9.48016835e-01,  6.86553275e-01,  4.25089715e-01,  2.60464511e-01,
        1.73309991e-01,  1.44258484e-01,  1.63626155e-01,  2.02361497e-01,        2.41096840e-01,  2.79832182e-01,  2.50780675e-01,  1.05523142e-01,
       -1.84991924e-01, -5.14242333e-01, -7.36970551e-01, -7.75705893e-01,       -6.49816031e-01, -4.36771649e-01, -2.81830280e-01, -2.81830280e-01,
       -4.85190826e-01, -8.24125071e-01, -1.15337548e+00, -1.39353460e+00,       -1.53588698e+00, -1.64047241e+00, -1.72956369e+00, -1.79444539e+00,
       -1.83995942e+00, -1.89999920e+00, -1.99683756e+00, -2.11788550e+00,       -2.20891355e+00, -2.21859739e+00, -2.13531640e+00, -1.99199564e+00,
       -1.82640205e+00, -1.64918786e+00, -1.45551115e+00, -1.24053000e+00,       -1.03716945e+00, -8.82228084e-01, -8.04757399e-01, -7.75705893e-01,
       -7.66022057e-01, -7.46654386e-01, -7.56338222e-01, -8.62860413e-01,       -1.05653712e+00, -1.25215060e+00, -1.33349482e+00, -1.27151827e+00,
       -1.10495630e+00, -9.01595755e-01, -7.46654386e-01, -6.01396853e-01,       -3.39933293e-01,  1.53942320e-01,  7.93075466e-01,  1.28695108e+00,
        1.35473793e+00,  1.03517135e+00,  7.64023959e-01,  9.09281492e-01,        1.36442176e+00,  1.77114286e+00,  1.86798121e+00,  1.60651765e+00,
        1.15137738e+00,  6.76869439e-01,  2.12045333e-01, -2.33411102e-01,       -5.62661511e-01, -7.07919044e-01, -6.78867537e-01, -5.14242333e-01,
       -3.20565622e-01, -2.04359596e-01, -1.65624253e-01, -1.75308089e-01,       -2.33411102e-01, -3.39933293e-01, -4.56139320e-01, -5.52977675e-01,
       -6.30448360e-01, -6.78867537e-01, -7.07919044e-01, -7.07919044e-01,       -6.69183702e-01, -5.91713017e-01, -5.04558497e-01, -4.65823155e-01,
       -5.04558497e-01, -6.11080689e-01, -7.07919044e-01, -7.66022057e-01,       -8.14441235e-01, -9.20963426e-01, -1.06622096e+00, -1.13400781e+00,
       -1.02748562e+00, -8.33808906e-01, -7.85389728e-01, -1.02748562e+00,       -1.46035307e+00, -1.85545356e+00, -2.07043471e+00, -2.09270753e+00,
       -1.95132353e+00, -1.68792320e+00, -1.38288238e+00, -1.16983800e+00,       -1.12432397e+00, -1.19404759e+00, -1.26183444e+00, -1.25699252e+00,
       -1.17371153e+00, -1.05653712e+00, -9.69382604e-01, -9.30647262e-01,       -8.82228084e-01, -7.66022057e-01, -6.01396853e-01, -4.94874662e-01,
       -4.94874662e-01, -5.91713017e-01, -7.66022057e-01, -9.88750275e-01,       -1.17467992e+00, -1.27539181e+00, -1.24343515e+00, -1.06622096e+00,
       -7.85389728e-01, -5.04558497e-01, -3.10881787e-01, -1.94675760e-01,       -1.36572747e-01, -1.46256582e-01, -2.43094938e-01, -3.68984800e-01,
       -4.27087813e-01, -2.91514115e-01,  4.74201287e-02,  4.15405879e-01,        6.09082590e-01,  5.31611906e-01,  2.79832182e-01,  8.61554709e-02,
        1.15206978e-01,  4.63825057e-01,  1.05453903e+00,  1.77114286e+00,        2.37154066e+00,  2.57490121e+00,  2.36185682e+00,  2.16818011e+00,
        2.30375381e+00,  2.59426888e+00,  2.72015874e+00,  2.65237189e+00,        2.42964367e+00,  2.08102559e+00,  1.74209135e+00,  1.56778231e+00,
        1.47094395e+00,  1.27726724e+00,  9.86752177e-01,  8.02759301e-01,        8.51178479e-01,  1.02548752e+00,  1.11264204e+00,  1.01580368e+00,
        8.12443137e-01,  6.76869439e-01,  5.99398755e-01,  4.83192728e-01,        2.89516017e-01,  7.64716353e-02, -7.84697334e-02, -1.84991924e-01,
       -2.72146444e-01, -3.49617129e-01, -3.88352471e-01, -3.98036306e-01,       -3.78668635e-01, -2.72146444e-01, -4.94182268e-02,  3.08883688e-01,
        7.05920946e-01,  1.01580368e+00,  1.09327437e+00,  8.70546150e-01,        4.34773551e-01, -3.00505557e-02, -3.20565622e-01, -3.39933293e-01,
       -1.65624253e-01,  5.71039642e-02,  2.41096840e-01,  4.05722044e-01,        5.12244235e-01,  5.02560399e-01,  3.28251360e-01,  6.67877998e-02,
       -1.65624253e-01, -3.20565622e-01, -4.17403978e-01, -5.43293840e-01,       -7.36970551e-01, -8.82228084e-01, -8.91911919e-01, -8.04757399e-01,
       -7.46654386e-01, -7.85389728e-01, -8.91911919e-01, -9.88750275e-01,       -1.03716945e+00, -1.04685329e+00, -1.02748562e+00, -9.79066439e-01,
       -9.40331097e-01, -9.50014933e-01, -1.05653712e+00, -1.24537192e+00,       -1.45066923e+00, -1.59883191e+00, -1.63272534e+00, -1.53395022e+00,
       -1.32187422e+00, -1.04685329e+00, -7.56338222e-01, -5.14242333e-01,       -3.59300964e-01, -2.81830280e-01, -2.14043431e-01, -1.46256582e-01,
       -7.84697334e-02, -3.00505557e-02,  2.80524576e-02,  1.34574649e-01,        2.60464511e-01,  3.57302866e-01,  3.66986702e-01,  2.12045333e-01,
       -1.07521240e-01, -4.46455484e-01, -5.82029182e-01, -4.07720142e-01,       -5.91020623e-02,  2.99199853e-01,  6.18766426e-01,  8.99597657e-01,
        1.06422286e+00,  1.02548752e+00,  8.89913821e-01,  9.38332999e-01,        1.28695108e+00,  1.75177519e+00,  2.04229025e+00,  2.05197409e+00,
        1.91640039e+00,  1.76145902e+00,  1.59683382e+00,  1.42252478e+00,        1.18042889e+00,  8.12443137e-01,  3.47619031e-01, -5.91020623e-02,
       -2.14043431e-01, -5.91020623e-02,  2.79832182e-01,  4.73508893e-01,        3.08883688e-01, -2.04359596e-01, -7.46654386e-01, -1.00811795e+00,
       -8.82228084e-01, -4.85190826e-01, -4.94182268e-02,  1.92677662e-01,        1.44258484e-01, -5.91020623e-02, -1.94675760e-01, -1.84991924e-01,
       -1.07521240e-01, -8.81535690e-02, -1.55940418e-01, -2.52778773e-01,       -2.33411102e-01, -4.94182268e-02,  2.79832182e-01,  6.09082590e-01,
        7.73707795e-01,  7.64023959e-01,  7.44656288e-01,  8.70546150e-01,        1.15137738e+00,  1.39347327e+00,  1.39347327e+00,  1.18042889e+00,
        8.80229986e-01,  6.47817933e-01,  4.63825057e-01,  3.28251360e-01,        2.31413004e-01,  1.53942320e-01,  9.58393064e-02,  3.77362932e-02,
        6.67877998e-02,  2.02361497e-01,  4.63825057e-01,  7.64023959e-01,        1.02548752e+00,  1.16106122e+00,  1.15137738e+00,  1.00611985e+00,
        8.31810808e-01,  6.96237110e-01,  5.89714919e-01,  4.92876564e-01,        4.44457386e-01,  4.92876564e-01,  6.28450262e-01,  7.05920946e-01,
        6.38134097e-01,  5.12244235e-01,  4.63825057e-01,  5.02560399e-01,        5.21928071e-01,  3.86354373e-01,  8.61554709e-02, -2.62462609e-01,
       -5.43293840e-01, -6.59499866e-01, -6.01396853e-01, -4.75506991e-01,       -3.68984800e-01, -2.91514115e-01, -2.14043431e-01, -1.17205076e-01,
       -4.94182268e-02, -1.17205076e-01, -3.30249458e-01, -5.33610004e-01,       -5.14242333e-01, -1.94675760e-01,  2.31413004e-01,  4.34773551e-01,
        2.70148346e-01, -1.36572747e-01, -4.94874662e-01, -6.69183702e-01,       -6.98235208e-01, -7.27286715e-01, -8.43492742e-01, -1.03716945e+00,
       -1.22213071e+00, -1.26280282e+00, -1.11464014e+00, -8.24125071e-01,       -5.52977675e-01, -4.17403978e-01, -4.46455484e-01, -5.23926169e-01,
       -5.33610004e-01, -4.85190826e-01, -4.17403978e-01, -3.68984800e-01,       -3.10881787e-01, -2.72146444e-01, -2.72146444e-01, -3.68984800e-01,
       -5.82029182e-01, -8.43492742e-01, -1.07590479e+00, -1.19307920e+00,       -1.18339537e+00, -1.09527247e+00, -9.88750275e-01, -8.72544248e-01,
       -7.36970551e-01, -6.01396853e-01, -5.82029182e-01, -7.07919044e-01,       -8.91911919e-01, -1.01780178e+00, -1.01780178e+00, -9.11279590e-01,
       -7.36970551e-01, -5.62661511e-01, -4.65823155e-01, -4.36771649e-01,       -4.36771649e-01, -3.59300964e-01, -8.81535690e-02,  4.15405879e-01,
        9.48016835e-01,  1.12232587e+00,  8.80229986e-01,  5.02560399e-01,        2.02361497e-01,  2.80524576e-02, -9.78374045e-02, -2.23727267e-01,
       -3.49617129e-01, -4.36771649e-01, -3.98036306e-01, -1.55940418e-01,        2.41096840e-01,  6.28450262e-01,  8.99597657e-01,  1.07390670e+00,
        1.22884807e+00,  1.33537026e+00,  1.21916423e+00,  9.09281492e-01,        6.47817933e-01,  7.05920946e-01,  1.03517135e+00,  1.25789957e+00,
        1.10295820e+00,  6.57501768e-01,  2.60464511e-01,  1.44258484e-01,        3.28251360e-01,  6.28450262e-01,  8.12443137e-01,  8.22126972e-01,
        7.34972453e-01,  6.09082590e-01,  4.15405879e-01,  1.63626155e-01,       -6.87858979e-02, -2.04359596e-01, -2.23727267e-01, -7.84697334e-02,
        2.89516017e-01,  8.31810808e-01,  1.25789957e+00,  1.16106122e+00,        5.89714919e-01, -3.97343912e-02, -3.39933293e-01, -3.39933293e-01,
       -2.04359596e-01,  2.80524576e-02,  4.05722044e-01,  8.12443137e-01,        1.07390670e+00,  1.17074505e+00,  1.17074505e+00,  1.14169355e+00,
        1.11264204e+00,  1.05453903e+00,  8.60862315e-01,  5.89714919e-01,        3.86354373e-01,  3.86354373e-01,  5.60663413e-01,  8.51178479e-01,
        1.14169355e+00,  1.38378943e+00,  1.54841464e+00,  1.64525299e+00,        1.63556916e+00,  1.55809847e+00,  1.41284094e+00,  1.19979656e+00,
        9.57700670e-01,  7.34972453e-01,  5.41295742e-01,  3.76670537e-01,        2.89516017e-01,  3.47619031e-01,  4.92876564e-01,  5.89714919e-01,
        5.12244235e-01,  2.70148346e-01, -7.84697334e-02, -4.65823155e-01,       -8.14441235e-01, -1.03716945e+00, -1.09527247e+00, -1.02748562e+00,
       -8.53176577e-01, -6.11080689e-01, -3.59300964e-01, -1.84991924e-01,       -1.07521240e-01, -9.78374045e-02, -8.81535690e-02, -7.84697334e-02,
       -7.84697334e-02, -8.81535690e-02, -7.84697334e-02, -3.97343912e-02,       -1.06828846e-02, -3.97343912e-02, -1.46256582e-01, -3.10881787e-01,
       -4.65823155e-01, -5.62661511e-01, -5.82029182e-01, -5.62661511e-01,       -5.52977675e-01, -6.11080689e-01, -7.07919044e-01, -8.43492742e-01,
       -9.50014933e-01, -9.98434110e-01, -9.69382604e-01, -9.11279590e-01,       -9.01595755e-01, -9.69382604e-01, -1.11464014e+00, -1.27539181e+00,
       -1.39062945e+00, -1.44389055e+00, -1.48068912e+00, -1.55331789e+00,       -1.67436583e+00, -1.80316084e+00, -1.88644183e+00, -1.90290435e+00]


turb_samples_low = [ 9.91804332e-01,  9.08836831e-01,  8.35488750e-01,  7.81379510e-01,        7.41699401e-01,  7.09233857e-01,  6.68351320e-01,  6.01015377e-01,
               4.95201752e-01,  3.68946859e-01,  2.46299248e-01,  1.46497761e-01,        6.47326874e-02, -5.00811076e-03, -6.75343436e-02, -1.15631446e-01,
              -1.40882424e-01, -1.48096990e-01, -1.61323693e-01, -2.08218367e-01,       -2.93590724e-01, -3.94594638e-01, -4.75157285e-01, -5.10027684e-01,
              -4.96800981e-01, -4.61930581e-01, -4.31869893e-01, -4.25857755e-01,       -4.40286885e-01, -4.55918444e-01, -4.40286885e-01, -3.68141232e-01,
              -2.39481484e-01, -8.31659018e-02,  5.03035567e-02,  1.14032217e-01,        9.35909487e-02,  5.81373723e-03, -1.18036301e-01, -2.43088767e-01,
              -3.56116957e-01, -4.47501451e-01, -5.06420401e-01, -5.30468952e-01,       -5.35278662e-01, -5.46100510e-01, -5.85780620e-01, -6.56723845e-01,
              -7.38488919e-01, -7.97407869e-01, -7.97407869e-01, -7.15642795e-01,       -5.48505365e-01, -3.03210144e-01, -1.82348139e-02,  2.88384213e-01,
               5.96205666e-01,  8.79978569e-01,  1.09761796e+00,  1.19862187e+00,        1.16615633e+00,  1.04110386e+00,  9.00419838e-01,  8.21059619e-01,
               8.48715453e-01,  9.82184911e-01,  1.15653691e+00,  1.27798209e+00,        1.27196995e+00,  1.13128593e+00,  9.06431976e-01,  6.63541610e-01,
               4.56724070e-01,  3.08825481e-01,  2.25857980e-01,  1.96999718e-01,        2.01809429e-01,  2.13833704e-01,  1.93392436e-01,  1.10424934e-01,
              -3.62712272e-02, -2.09420795e-01, -3.45295109e-01, -3.93392211e-01,       -3.56116957e-01, -2.97198006e-01, -2.85173731e-01, -3.48902391e-01,
              -4.61930581e-01, -5.73756344e-01, -6.43497142e-01, -6.65140838e-01,       -6.59128700e-01, -6.51914135e-01, -6.51914135e-01, -6.48306852e-01,
              -6.24258301e-01, -5.70149061e-01, -4.85979133e-01, -3.95797066e-01,       -3.24853840e-01, -2.91185869e-01, -3.09222282e-01, -3.71748515e-01,
              -4.70347574e-01, -5.85780620e-01, -7.00011237e-01, -7.92598159e-01,       -8.50314682e-01, -8.68351095e-01, -8.53921964e-01, -8.17849138e-01,
              -7.73359318e-01, -7.27667071e-01, -6.81974824e-01, -6.30270439e-01,       -5.67744206e-01, -4.90788843e-01, -4.10226197e-01, -3.45295109e-01,
              -3.16436847e-01, -3.30865978e-01, -3.81367935e-01, -4.43894168e-01,       -4.93193698e-01, -5.20849532e-01, -5.43695655e-01, -5.86983047e-01,
              -6.69950548e-01, -7.85383594e-01, -9.12840914e-01, -1.03188124e+00,       -1.12927787e+00, -1.20503081e+00, -1.26154491e+00, -1.30723715e+00,
              -1.35172697e+00, -1.40102650e+00, -1.45152846e+00, -1.49361342e+00,       -1.50684013e+00, -1.46475516e+00, -1.34571483e+00, -1.12807545e+00,
              -8.22658848e-01, -4.53513589e-01, -8.31659018e-02,  2.04214284e-01,        3.35278887e-01,  2.94396350e-01,  1.48902616e-01,  1.66355852e-02,
               2.02428679e-02,  2.37882255e-01,  6.56327044e-01,  1.16134662e+00,        1.56656470e+00,  1.73490456e+00,  1.66636619e+00,  1.47998992e+00,
               1.28760151e+00,  1.13609564e+00,  1.02426988e+00,  9.34087809e-01,        8.52322736e-01,  7.69355234e-01,  6.89995016e-01,  6.29873638e-01,
               6.11837225e-01,  6.46707624e-01,  7.28472697e-01,  8.43905743e-01,        9.83387339e-01,  1.14090535e+00,  1.29962579e+00,  1.44030981e+00,
               1.52928945e+00,  1.53650401e+00,  1.44872680e+00,  1.28279180e+00,        1.08318883e+00,  9.10039258e-01,  8.29476612e-01,  8.89597990e-01,
               1.11565437e+00,  1.47758506e+00,  1.87438616e+00,  2.18220761e+00,        2.32649892e+00,  2.33852319e+00,  2.26637754e+00,  2.17018334e+00,
               2.00304591e+00,  1.74572641e+00,  1.43069039e+00,  1.14932234e+00,        9.97816470e-01,  1.01585288e+00,  1.15653691e+00,  1.30323307e+00,
               1.32848405e+00,  1.16014419e+00,  8.25869329e-01,  4.23056099e-01,        1.00805514e-01, -6.03197783e-02, -4.10809374e-02,  1.08020079e-01,
               2.91991495e-01,  4.14639106e-01,  4.24258526e-01,  3.46100735e-01,        2.55918669e-01,  2.27060407e-01,  2.83574502e-01,  3.86983272e-01,
               4.65141063e-01,  4.62736208e-01,  3.68946859e-01,  2.28262835e-01,        9.96030865e-02,  2.38501505e-02,  1.78380128e-02,  8.51739558e-02,
               2.25857980e-01,  4.37485229e-01,  6.99614436e-01,  9.74970346e-01,        1.21184857e+00,  1.35854474e+00,  1.38620057e+00,  1.30563792e+00,
               1.15773933e+00,  9.82184911e-01,  8.33083895e-01,  7.46509111e-01,        7.62140669e-01,  9.02824693e-01,  1.14691749e+00,  1.42588068e+00,
               1.66275891e+00,  1.83711090e+00,  2.00184348e+00,  2.18220761e+00,        2.33852319e+00,  2.33852319e+00,  2.13411051e+00,  1.77217981e+00,
               1.37056901e+00,  1.05312814e+00,  8.67954294e-01,  8.15047481e-01,        8.57132446e-01,  9.38897519e-01,  1.00984075e+00,  1.03869901e+00,
               1.00743589e+00,  9.10039258e-01,  7.51318821e-01,  5.64942550e-01,        4.18246388e-01,  3.78566279e-01,  4.71153201e-01,  6.68351320e-01,
               8.59537301e-01,  9.36492664e-01,  8.31881467e-01,  5.57727985e-01,        1.96999718e-01, -1.51704272e-01, -4.16238334e-01, -5.67744206e-01,
              -6.09829171e-01, -5.70149061e-01, -4.75157285e-01, -3.58521812e-01,       -2.39481484e-01, -1.28858149e-01, -1.94372414e-02,  9.59958038e-02,
               2.21048269e-01,  3.32874032e-01,  4.05019685e-01,  4.21853671e-01,        3.89388127e-01,  3.22052184e-01,  2.39084683e-01,  1.60926892e-01,
               1.05615224e-01,  8.87812385e-02,  1.17639500e-01,  1.87380298e-01,        2.82372075e-01,  3.78566279e-01,  4.36282802e-01,  4.35080374e-01,
               3.86983272e-01,  3.20849756e-01,  2.65538089e-01,  2.27060407e-01,        2.01809429e-01,  1.78963305e-01,  1.46497761e-01,  8.99836660e-02,
              -3.80568321e-03, -1.28858149e-01, -2.63530035e-01, -3.78963080e-01,       -4.41489313e-01, -4.37882030e-01, -3.74153370e-01, -2.76756738e-01,
              -1.79360106e-01, -1.13226591e-01, -8.79756120e-02, -8.67731845e-02,       -8.43683294e-02, -6.63319160e-02, -4.22833650e-02, -4.34857925e-02,
              -9.87974600e-02, -2.14230505e-01, -3.77760653e-01, -5.42493228e-01,       -6.80772396e-01, -7.74561746e-01, -8.32278268e-01, -8.77970515e-01,
              -9.39294321e-01, -1.03909581e+00, -1.18218469e+00, -1.35172697e+00,       -1.51886440e+00, -1.65113143e+00, -1.72327709e+00, -1.72327709e+00,
              -1.65473872e+00, -1.54411538e+00, -1.43950418e+00, -1.38178766e+00,       -1.39862165e+00, -1.49000614e+00, -1.63670230e+00, -1.80383973e+00,
              -1.95775046e+00, -2.06957622e+00, -2.12609032e+00, -2.12128061e+00,       -2.05995680e+00, -1.95414318e+00, -1.81947129e+00, -1.67397756e+00,
              -1.53329353e+00, -1.41906291e+00, -1.33729784e+00, -1.27837889e+00,       -1.22186480e+00, -1.12927787e+00, -9.54925879e-01, -6.57926273e-01,
              -2.29862063e-01,  2.75157509e-01,  7.30877553e-01,  9.91804332e-01,        9.85792194e-01,  7.69355234e-01,  4.80772621e-01,  2.31870117e-01,
               6.23278323e-02, -7.71537640e-02, -2.34671774e-01, -4.25857755e-01,       -6.33877722e-01, -8.29873413e-01, -9.87391423e-01, -1.09080019e+00,
              -1.14009972e+00, -1.14851672e+00, -1.14250458e+00, -1.15573128e+00,       -1.21705509e+00, -1.33128570e+00, -1.48519643e+00, -1.63670230e+00,
              -1.75814749e+00, -1.83149557e+00, -1.85915140e+00, -1.85313926e+00,       -1.82548343e+00, -1.78219604e+00, -1.72568194e+00, -1.65353629e+00,
              -1.56575908e+00, -1.47076730e+00, -1.38058523e+00, -1.30362987e+00,       -1.24471092e+00, -1.20142353e+00, -1.17016041e+00, -1.14490943e+00,
              -1.11965845e+00, -1.09080019e+00, -1.06554921e+00, -1.06073950e+00,       -1.09200262e+00, -1.14370700e+00, -1.17737498e+00, -1.14130215e+00,
              -1.01865454e+00, -8.46707399e-01, -6.95201527e-01, -6.35080149e-01,       -7.00011237e-01, -8.58731674e-01, -1.05592979e+00, -1.23028179e+00,
              -1.34451241e+00, -1.39381194e+00, -1.39982407e+00, -1.39982407e+00,       -1.43108719e+00, -1.51405469e+00, -1.64752415e+00, -1.80985187e+00,
              -1.96977473e+00, -2.09362477e+00, -2.16456800e+00, -2.18380684e+00,       -2.16456800e+00, -2.12609032e+00, -2.08881506e+00, -2.06596894e+00,
              -2.06957622e+00, -2.10564905e+00, -2.17178256e+00, -2.25955978e+00,       -2.35695641e+00, -2.44593605e+00, -2.51086713e+00, -2.53010598e+00,
              -2.48681858e+00, -2.37138554e+00, -2.17058014e+00, -1.89161694e+00,       -1.52728139e+00, -1.08478805e+00, -6.01412178e-01, -1.32465432e-01,
               2.78764792e-01,  6.01015377e-01,  8.17452336e-01,  9.59338788e-01,        1.08078397e+00,  1.18659760e+00,  1.18299031e+00,  9.80982484e-01,
               6.20254218e-01,  2.36679828e-01, -1.82348139e-02, -1.03607170e-01,       -4.46882201e-02,  9.35909487e-02,  2.33072545e-01,  3.11230336e-01,
               3.14837619e-01,  2.81169647e-01,  2.77562365e-01,  3.49708018e-01,        5.04821172e-01,  7.09233857e-01,  9.25670816e-01,  1.12767865e+00,
               1.30443550e+00,  1.42948796e+00,  1.47998992e+00,  1.42708311e+00,        1.26716024e+00,  1.03268687e+00,  8.03023206e-01,  6.65946465e-01,
               6.68351320e-01,  7.78974655e-01,  8.94407700e-01,  9.07634403e-01,        7.69355234e-01,  5.09630883e-01,  2.06619139e-01, -6.51294885e-02,
              -2.34671774e-01, -2.87578586e-01, -2.28659636e-01, -8.55707569e-02,        9.47933763e-02,  2.67942944e-01,  4.11031823e-01,  5.24060013e-01,
               6.19051790e-01,  6.98412009e-01,  7.53723676e-01,  7.75367372e-01,        7.60938241e-01,  7.27270270e-01,  6.92399871e-01,  6.63541610e-01,
               6.23861500e-01,  5.62537695e-01,  5.01213890e-01,  4.87987187e-01,        5.66144978e-01,  7.21258132e-01,  8.89597990e-01,  1.00382861e+00,
               1.02186502e+00,  9.58136360e-01,  8.60739728e-01,  7.92201358e-01,        7.97011068e-01,  8.76371287e-01,  9.78577629e-01,  1.04471114e+00,
               1.03629415e+00,  9.46112085e-01,  7.94606213e-01,  6.15444507e-01,        4.43497367e-01,  2.90789068e-01,  1.47700189e-01, -6.21053832e-03,
              -1.76955251e-01, -3.42890254e-01, -4.67942719e-01, -5.22051959e-01,       -4.99205836e-01, -4.31869893e-01, -3.71748515e-01, -3.63331522e-01,
              -4.23452900e-01, -5.24456814e-01, -6.17043736e-01, -6.57926273e-01,       -6.31472867e-01, -5.47302938e-01, -4.33072320e-01, -3.14031992e-01,
              -2.01003802e-01, -9.03804671e-02,  3.70768536e-02,  2.04214284e-01,        3.94197837e-01,  5.82978963e-01,  7.35687263e-01,  8.37893605e-01,
               9.06431976e-01,  9.70160636e-01,  1.05553299e+00,  1.15533448e+00,        1.23469470e+00,  1.23349227e+00,  1.10964223e+00,  8.69156721e-01,
               5.78169253e-01,  3.19647329e-01,  1.51307471e-01,  9.47933763e-02,        1.16437072e-01,  1.64534174e-01,  1.87380298e-01,  1.62129319e-01,
               8.99836660e-02,  2.20645456e-03, -6.63319160e-02, -8.19634742e-02,       -3.38663721e-02,  7.67569629e-02,  2.36679828e-01,  4.23056099e-01,
               6.07027514e-01,  7.52521249e-01,  8.18654764e-01,  8.06630488e-01,        7.51318821e-01,  7.12841139e-01,  7.35687263e-01,  8.23464474e-01,
               9.47314512e-01,  1.06875970e+00,  1.17216847e+00,  1.27798209e+00,        1.41024912e+00,  1.56776713e+00,  1.70604630e+00,  1.75775068e+00,
               1.66396133e+00,  1.42948796e+00,  1.12046408e+00,  8.40298460e-01,        6.68351320e-01,  6.32278493e-01,  7.04424146e-01,  8.34286322e-01]


nCycles = 120

ntime = 5.0*nCycles
narrs = Int(round(ntime/600.0) + 1)

samp_spl = copy(turb_samples_high)
for i = 1:narrs-1
   append!(samp_spl,turb_samples_high)
end
t_spl = range(0.0,stop=600*narrs,length=length(turb_samples_high)*narrs)
spl = Akima(t_spl,samp_spl)
sample_times = range(0.0,stop=ntime,length=naz*nCycles)
turb_samples = spl.(sample_times)

turbine_ID = 2
state_ID = 1

turb = "high"
# turb = "low"

off = range(-1.0,stop=1.0,length=100)
# off = [0.6]
ws_arr = [13.0]
run = true
sep_arr = [4.0,7.0,10.0]
# sep_arr = [-2.0,7.0,10.0]
# sep_arr = [4.0]

plotting = true
figure(2,figsize=(6,2.5))
for w = 1:length(sep_arr)
                sep = sep_arr[w]
                for j = 1:length(ws_arr)
                    if run == true

                        global t1_damage
                        global t2_damage

                        t1_damage = zeros(length(off))

                        for k=1:length(off)

                            global t1_damage
                            global t2_damage

                            offset = off[k]*rotor_diameter[1]
                            turbine_y = offset

                            ti_arr, ti_locs = get_ti_data(ws_arr[j],turb,sep)
                            vel_arr, vel_locs = get_vel_data(ws_arr[j],turb,sep)

                            turbulence_func = Akima(ti_locs,ti_arr)
                            U_func = Akima(vel_locs,vel_arr)

                            t1_damage[k] = SOWFA_damage(turbine_y,nCycles,az_arr,turb_samples,pitch_func,turbulence_func,U_func,
                                r,sections,Rhub,Rtip,precone,tilt;Nlocs=Nlocs,fos=1.15)

                        end

                        if plotting == true

                            if w == 1 && j == 1
                                            subplot(131)
                                            title("4 D",fontsize=10)
                                            # ylabel(string("damage\n", L"$U_\infty = 13$ m/s"))
                                            tick_params(
                                                        axis="y",          # changes apply to the x-axis
                                                        which="both",      # both major and minor ticks are affected
                                                        right=false,      # ticks along the bottom edge are off
                                                        top=false,         # ticks along the top edge are off
                                                        labelright=false) # labels along the bottom edge are off
                                xlabel("offset (D)")
                            elseif w == 2 && j == 1
                                            subplot(132)
                                            title("7 D",fontsize=10)
                                            tick_params(
                                                        axis="y",          # changes apply to the x-axis
                                                        which="both",      # both major and minor ticks are affected
                                                        right=false,      # ticks along the bottom edge are off
                                                        top=false,         # ticks along the top edge are off
                                                        labelright=false,
                                                        labelleft=false) # labels along the bottom edge are off
                                xlabel("offset (D)")
                            elseif w == 3 && j == 1
                                            subplot(133)
                                            title("10 D",fontsize=10)
                                            tick_params(
                                                        axis="y",          # changes apply to the x-axis
                                                        which="both",      # both major and minor ticks are affected
                                                        right=false,      # ticks along the bottom edge are off
                                                        top=false,         # ticks along the top edge are off
                                                        labelright=false,
                                                        labelleft=false) # labels along the bottom edge are off
                                xlabel("offset (D)")
                           end


                            # include("FAST_data.jl")
                            include("FAST_data_NEW.jl")
                            FS,FD = fastdata(turb,ws_arr[j],sep)

                            if w == 3 && j == 1
                                            plot(FS,FD,"o",markersize=5,label="SOWFA/\nOpenFAST")
                                            plot(off,t1_damage,label="model")
                                            legend(loc=1)
                            else
                                            plot(FS,FD,"o",markersize=5)
                                            plot(off,t1_damage)
                            end

                            #
                            #



                            # title("$sep, 13 m/s")
                            ylim(-0.1,3.0)
                            # ylim(-0.1,.0)
                            # ylim(0.0,1.1)
                    end
                    end
                #     # legend(["model", "FAST"])
                #     # legend(["10 m/s","","11 m/s","","12m/s",""])
                end
end
# suptitle("8% turbulence intensity",y=0.97)
# subplots_adjust(top=0.91,bottom=0.19,left=0.13,right=0.99,wspace=0.1,hspace=0.1)
# savefig("damage_13.pdf",transparent=true)
