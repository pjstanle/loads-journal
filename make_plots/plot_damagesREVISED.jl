using FlowFarm
const ff = FlowFarm
using DelimitedFiles
using FLOWMath
using CCBlade
using PyPlot


include("../model_lowTI_NEW.jl")
nCycles = 50


t = time()


# starting
turbine_x = readdlm("../layout_opt_small/x_40_small_26.txt")[:,1]
turbine_y = readdlm("../layout_opt_small/y_40_small_26.txt")[:,1]

# 0.05
# xopt = [60.3201544018684, 95.37927338567802, 151.2750213662074, 75.83999999999997, 127.82425457941739, -4.2799097599299785e-14, 167.56696131290767, -28.783386361131267, 218.12696131290767, 33.176307455968235, 21.77661363886874, -15.242623251634718, 306.45840772733874, 294.2719226650399, -23.519458769254147, 47.05661363886874, 192.84696131290767, 212.82160631440146, 112.17048572894635, -5.962863063064856, 9.163624602604807, 164.65895572303475, 126.39999999999996, 50.55999999999997, 227.11502136620743, 252.39502136620743, 298.6291967356832, 281.1784077273387, 146.9834806567086, 262.7977018506897, 101.11999999999996, 176.5550213662074, 72.33661363886873, 243.3799358298205, -3.503386361131265, 282.7209460094409, 277.67502136620743, 201.8350213662074, 288.65895352105895, 25.27999999999995, 166.2831828477722, 225.759855802248, 236.15805204419888, -0.3359289502762173, 226.71298028200533, -0.3359289502762157, -0.3359289502762173, 236.15805204419888, -0.33592895027621755, 150.70837764614646, 236.15805204419888, 124.90258914313002, -0.3359289502762171, 87.10579246475974, 192.90785291020254, 236.15805204419888, -0.33592895027621417, 101.81895542016551, 206.86050448797974, 48.656959037823725, 138.26930280194176, 154.96479938749857, -0.3359289502762169, -0.33592895027621833, 236.15805204419888, 236.15805204419888, 26.46678929542608, -0.33592895027621805, 14.34062100636385, 17.02004195127278, -0.3359289502762173, 236.15805204419888, 236.15805204419888, 0.8326943892064683, 236.15805204419888, 194.69903844155138, 236.15805204419888, 236.15805204419888, 145.91037202202233, -0.3359289502762177]

# 0.0475
# xopt = [60.619348288318136, 95.45813202055189, 153.87982008899883, 75.82785415755211, 130.10125263558032, -0.012165116370317058, 166.67800373798784, -28.783386361131264, 217.23649462077188, 32.98111322661868, 21.776633671131904, -13.935058793256877, 306.3734191757481, 293.3790526007047, -23.812905695068373, 47.05663367113191, 191.9591790814932, 206.28762254392882, 112.7667566668829, -5.808925062857798, 8.904800971869024, 164.64620032587618, 126.38846382319647, 50.54785143948096, 229.69780453727637, 254.9778045372764, 298.22692833636114, 281.09341917574807, 146.47670337692819, 262.24437278779106, 101.10785415755211, 179.13810175309536, 72.33663372105988, 242.49577086804874, -3.5033763192165464, 283.17099258228353, 278.4943381354213, 204.41795314518586, 288.78552471194536, 25.267848721409813, 165.16731956574034, 225.895206721708, 235.08433996247038, -0.3359289502762173, 226.49105901477353, -0.23597626355748283, -0.04084069370683927, 236.1580520441989, -0.33592895027621755, 151.78922342566764, 236.15805204419888, 127.50276545255454, -0.3359289502762171, 85.6554798928325, 195.3189115266449, 236.15805204419888, 0.1395172993469049, 101.18302555654402, 207.45472298241788, 47.39215266519839, 141.26238593331246, 147.5751507816366, -0.19185607798415127, -0.3193516744161359, 236.15805204419888, 236.15805204419888, 31.964037687387318, -0.33592895027621805, 15.168554034073876, 16.51960576656476, -0.3359289502762173, 236.15805204419888, 236.15805204419888, 0.7317434737278993, 236.11908815673695, 190.17023083455786, 226.87997626805836, 235.9322595080568, 144.87042055709176, -0.3359289502762177]

# 0.045
# xopt = [63.47354754629584, 93.94260700165616, 151.31286778805298, 75.83999999999995, 128.66060896546517, -4.350560286350472e-14, 160.2530921682569, -28.783386361131267, 210.79498354301163, 33.73780491568329, 21.77661363886874, -12.800388913126687, 306.45840772733874, 292.81642179133036, -23.33313270520157, 47.05661363886874, 185.51804072271932, 214.08949171049173, 112.24958991812143, -6.185007219848126, 11.319962757057171, 169.43725049583702, 126.30969687713686, 50.55999999999996, 227.11502136620743, 252.39502136620743, 297.9011244854225, 280.1002502259763, 143.80261418639842, 256.8980689374555, 101.08760664319318, 176.5550213662074, 72.30134325986708, 236.06297257731967, -3.5033863611312657, 282.7853331046361, 277.67502136620743, 201.8350213662074, 289.64387110790705, 25.279999999999955, 171.7441904121157, 221.75660031860866, 234.77502100681247, -0.33592895027621733, 223.5520131133498, -0.3359289502762177, 1.7086425464525612, 236.1580520441989, 0.44325662592060355, 147.08296509579466, 236.15805204419888, 123.44412976174735, -0.3359289502762171, 80.23492943087501, 191.37693531426842, 236.1580520441989, 0.8363999327116671, 135.13734717655186, 204.32293241707748, 50.48217012776278, 135.3988411251874, 164.42790698291358, 2.6536141584957553, -0.33592895027621833, 236.15805204419888, 236.15805204419888, 23.451700264331418, 3.9443029836238277, 20.903991821748903, 13.981094475881847, 0.9434297916666637, 236.15805204419888, 234.82312639861323, -0.33592895027621733, 236.15805204419888, 187.77459248453746, 236.1580520441989, 236.15805204419888, 137.8179579418039, -0.3359289502762174]

# 0.0425
# xopt = [65.9753750087778, 98.28659662875394, 158.96343637128854, 74.03352232991834, 134.4752567268328, 0.14566460378992702, 162.03873629493603, -28.783386361131267, 212.59203319161125, 32.61967603368509, 24.741779529873533, -12.31789332089469, 306.4584077273387, 288.85574485280176, -22.90203027430342, 48.52780293562848, 187.31203319161122, 200.74170855162657, 116.33809985744979, -5.2783260875086615, 8.34941119267549, 157.26605030048324, 122.82294256566261, 48.75352232991835, 234.8031485721828, 256.088533019794, 297.8507724137088, 281.17840772733865, 142.17025899640612, 260.2707984498679, 98.42823253963772, 184.2431485721828, 73.80780293562849, 237.71773951409673, -3.5033863611312652, 278.742248504532, 277.37393163384, 209.5231485721828, 287.9725167205617, 24.44959346685414, 169.63737270177916, 229.8427511815731, 236.0329507059336, -0.33592895027621594, 229.75476031119706, -0.3359289502762176, 0.3054145980655882, 236.1580520441989, -0.3359289502762194, 154.57199755773135, 227.59607128685795, 124.41671197017173, -0.33592895027621705, 97.49621955229864, 187.83485278025577, 236.1580520441989, -0.33592895027621483, 113.8314092338384, 212.14447829991522, 43.032573065441575, 147.4986199519627, 163.5263652502504, -0.3359289502762172, -0.33592895027621883, 236.15805204419888, 222.51946788189082, 46.56156995106145, -0.33592895027621805, 15.936845394795425, 13.87531371354598, 6.295575129934867, 236.15805204419888, 236.1580520441989, 2.4543629986525795, 236.15805204419888, 182.8865785051259, 236.1580520441989, 236.1580520441989, 151.55036759495204, 6.621108183365084]

# 0.04
# xopt = [29.671274700914775, 85.40140537797119, 146.1235155946866, 79.0547555480611, 120.88190889619035, 2.0456524125791398, 161.01490214797545, -28.527085895629522, 210.02227553620196, 32.677387408755024, 20.8096344936254, 12.376219830352134, 306.2958733976406, 286.9714017753828, -22.765500577640935, 51.65294314741139, 184.74342514002126, 207.5522823010485, 105.71230348528182, -4.331223760101802, -5.508195333095918, 127.99713166377992, 129.53896889549227, 53.84272119886325, 222.34482657341883, 244.20084278379582, 291.8366767979637, 280.97986751039105, 149.94452696246694, 258.98737822805487, 105.52471663548093, 171.9089905933645, 75.40171299948139, 236.15780435690814, -3.258584751486667, 266.5023082812315, 271.39305658846615, 197.1793555428113, 283.7827521999944, 27.322115843600617, 196.63238761220077, 202.3414937559782, 236.1580520441989, 5.471511782672424, 234.76532403248626, 0.0934120444583693, 12.897841064389887, 236.15805204419888, -0.05701200870994004, 122.01946058327091, 220.30841457647557, 77.56424694288259, 0.8553781405819696, 152.51049467314493, 186.71307888323852, 236.1580520441989, -0.2980986730688261, 138.20354938985298, 187.26800964015865, 35.250861872485984, 151.37633312071227, 130.92265201603104, 9.271588833696528, 3.619020436266077, 233.44824609834725, 219.82888483933712, 61.665667235295565, -0.33592895027621805, 43.42757335023459, 12.349487635810021, -0.3171233027960849, 235.27871344577628, 227.4886705640134, 0.3859648230956744, 235.39318727799105, 203.26195639656027, 236.15805204419888, 235.97660694602948, 184.81027197559732, -0.33592895027621733]

# 0.0375
# xopt = [53.29648756898605, 77.9175886330757, 148.07528986934037, 83.17418393804026, 120.51770219663752, 21.005416324829095, 155.66918272054508, -27.672220403864674, 200.81151539272574, 38.5367862353218, 20.825498281186423, 20.926582812145032, 289.8957699196789, 289.7641640895101, -10.039061285390511, 39.58849056322875, 177.94989961299535, 232.32606772393797, 97.85089718574444, -1.4202350977256368, 10.312765761954497, 157.33990600681003, 130.19227517696737, 59.32610168357715, 222.21867967769222, 247.58475687666075, 270.1805625836482, 265.9471499957479, 150.22021452200212, 256.21911693660127, 107.70759499339682, 173.39282885084765, 96.24477097078487, 234.16624526679192, -3.0900466848395656, 265.6493919710731, 276.4244800447038, 200.9564058802872, 285.5103075648353, 43.28387093551336, 169.69877312361527, 175.43286265802772, 236.08680580278988, 6.1596324189114275, 229.09050868004877, -0.33592895027621716, 11.607607564647457, 227.028338900565, 10.45974840123658, 124.5707597494563, 224.81522197709415, 58.14360587633082, 7.759872665255181, 127.42015470638279, 123.22870022116903, 200.2062457532812, -0.33592895027621694, 129.28281011548597, 155.10487227561782, 11.333200178420235, 108.23264915763669, 164.77215690408133, 23.813309136520388, 14.54696665882602, 221.83563833746646, 211.6797701542067, 98.48536585463481, -0.3359289502762171, 39.23926369919158, 23.666944491084994, 12.258329383959625, 235.37908905742128, 236.1547340454255, 11.307767677365936, 233.0082163658532, 187.65561921410324, 236.1569204016498, 207.87038890612516, 171.78070595656752, 41.752936167417666]

# 0.035 not quite
# xopt = [75.27319485817515, 88.70885371386375, 148.41467161512549, 81.4340647399666, 123.11023283035888, 20.395267942863544, 161.2867966231085, -27.129807025043835, 207.48115994500785, 48.21953147242034, 17.796601365401955, -6.208750078299777, 291.0616304362533, 291.2362284799548, 23.960391304360055, 41.6236616037562, 183.58972500529234, 218.35029117408436, 98.9867959203743, 0.7146940435032826, -1.0668487020213822, 168.88441064326472, 127.02402972938327, 60.60374102117482, 220.6748744686635, 245.2096942172534, 272.5316078406137, 255.20210275714098, 147.6796677452093, 273.5057917362045, 104.04007513726616, 173.39787270787056, 71.65266621180767, 233.50066111328363, -4.999592956503526, 277.3815161905645, 264.6313051452869, 197.68094879880962, 287.86029719462493, 43.27480883335141, 123.44833998229745, 207.91796288639023, 228.8197982564252, 13.988039180020369, 221.0584612429901, 7.964552934309136, 19.829178092732082, 223.75436902007291, -0.33592895027621666, 104.38743181896432, 225.23047570561013, 50.67724943653379, 13.013280899750624, 110.87490223374539, 155.15966196322665, 233.67734504859513, 7.927105392433463, 105.08478359587703, 132.2086785124486, 24.596475244357535, 151.59375922830768, 144.30146612850191, 10.988419444689677, -0.3359272422067784, 236.15805204419888, 230.06534962780316, 84.65001075673887, 4.635719852561529, 41.13468075703154, 31.203139123420428, 0.46149057935631016, 232.6821897871145, 226.57713940478604, 17.60205449170609, 236.1580520441989, 192.05353951945747, 213.88266042382017, 225.6529208074966, 152.4724009547902, 18.71654765289518]

# turbine_x = xopt[1:nturbines].*10.0
# turbine_y = xopt[nturbines+1:end].*10.0

div_sigma = 2.38512084848453
div_ti = 1.1841406781776536
fos = 2.0



# starting
turbine_x1 = readdlm("../layout_opt_small/x_40_small_26.txt")[:,1]
turbine_y1 = readdlm("../layout_opt_small/y_40_small_26.txt")[:,1]

damage1 = ff.get_total_farm_damage_FINAL(turbine_x1,turbine_y1,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
        nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)

AEP1 = ff.calculate_aep(turbine_x1, turbine_y1, turbine_z, rotor_diameter,
            hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
            cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
            rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11


# 0.0425
# xopt = [65.9753750087778, 98.28659662875394, 158.96343637128854, 74.03352232991834, 134.4752567268328, 0.14566460378992702, 162.03873629493603, -28.783386361131267, 212.59203319161125, 32.61967603368509, 24.741779529873533, -12.31789332089469, 306.4584077273387, 288.85574485280176, -22.90203027430342, 48.52780293562848, 187.31203319161122, 200.74170855162657, 116.33809985744979, -5.2783260875086615, 8.34941119267549, 157.26605030048324, 122.82294256566261, 48.75352232991835, 234.8031485721828, 256.088533019794, 297.8507724137088, 281.17840772733865, 142.17025899640612, 260.2707984498679, 98.42823253963772, 184.2431485721828, 73.80780293562849, 237.71773951409673, -3.5033863611312652, 278.742248504532, 277.37393163384, 209.5231485721828, 287.9725167205617, 24.44959346685414, 169.63737270177916, 229.8427511815731, 236.0329507059336, -0.33592895027621594, 229.75476031119706, -0.3359289502762176, 0.3054145980655882, 236.1580520441989, -0.3359289502762194, 154.57199755773135, 227.59607128685795, 124.41671197017173, -0.33592895027621705, 97.49621955229864, 187.83485278025577, 236.1580520441989, -0.33592895027621483, 113.8314092338384, 212.14447829991522, 43.032573065441575, 147.4986199519627, 163.5263652502504, -0.3359289502762172, -0.33592895027621883, 236.15805204419888, 222.51946788189082, 46.56156995106145, -0.33592895027621805, 15.936845394795425, 13.87531371354598, 6.295575129934867, 236.15805204419888, 236.1580520441989, 2.4543629986525795, 236.15805204419888, 182.8865785051259, 236.1580520441989, 236.1580520441989, 151.55036759495204, 6.621108183365084]

xopt = [53.29648756898605, 77.9175886330757, 148.07528986934037, 83.17418393804026, 120.51770219663752, 21.005416324829095, 155.66918272054508, -27.672220403864674, 200.81151539272574, 38.5367862353218, 20.825498281186423, 20.926582812145032, 289.8957699196789, 289.7641640895101, -10.039061285390511, 39.58849056322875, 177.94989961299535, 232.32606772393797, 97.85089718574444, -1.4202350977256368, 10.312765761954497, 157.33990600681003, 130.19227517696737, 59.32610168357715, 222.21867967769222, 247.58475687666075, 270.1805625836482, 265.9471499957479, 150.22021452200212, 256.21911693660127, 107.70759499339682, 173.39282885084765, 96.24477097078487, 234.16624526679192, -3.0900466848395656, 265.6493919710731, 276.4244800447038, 200.9564058802872, 285.5103075648353, 43.28387093551336, 169.69877312361527, 175.43286265802772, 236.08680580278988, 6.1596324189114275, 229.09050868004877, -0.33592895027621716, 11.607607564647457, 227.028338900565, 10.45974840123658, 124.5707597494563, 224.81522197709415, 58.14360587633082, 7.759872665255181, 127.42015470638279, 123.22870022116903, 200.2062457532812, -0.33592895027621694, 129.28281011548597, 155.10487227561782, 11.333200178420235, 108.23264915763669, 164.77215690408133, 23.813309136520388, 14.54696665882602, 221.83563833746646, 211.6797701542067, 98.48536585463481, -0.3359289502762171, 39.23926369919158, 23.666944491084994, 12.258329383959625, 235.37908905742128, 236.1547340454255, 11.307767677365936, 233.0082163658532, 187.65561921410324, 236.1569204016498, 207.87038890612516, 171.78070595656752, 41.752936167417666]
turbine_x2 = xopt[1:nturbines].*10.0
turbine_y2 = xopt[nturbines+1:end].*10.0

damage2 = ff.get_total_farm_damage_FINAL(turbine_x2,turbine_y2,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
        nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)

AEP2 = ff.calculate_aep(turbine_x2, turbine_y2, turbine_z, rotor_diameter,
            hub_height, turbine_yaw, ct_model, generator_efficiency, cut_in_speed,
            cut_out_speed, rated_speed, rated_power, windresource, power_model, model_set,
            rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z)/1e11

figure(1,figsize=(6.5,2.5))
subplot(121)
plot(damage1./maximum(damage1),"o",color="C0",markersize=4)
ylim(0.0,1.03)
ylabel("damage")
xlabel("turbine number")
title("no damage constraints",fontsize=10)

subplot(122)
plot(damage2./maximum(damage1),"o",color="C1",markersize=4)
ylim(0.0,1.03)
xlabel("turbine number")
title("with damage constraints",fontsize=10)

# println("maximum damage: ", maximum(damage))
# println("AEP: ", AEP)


subplots_adjust(top=0.9,left=0.12,right=0.98,bottom=0.18,wspace=0.2)

# savefig("opt_damage_vals2.pdf",transparent=true)
