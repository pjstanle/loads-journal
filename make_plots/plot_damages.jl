using FlowFarm
const ff = FlowFarm
using DelimitedFiles
using FLOWMath
using CCBlade
using PyPlot


include("../model_lowTI_NEW.jl")
nCycles = 50

turbine_x = readdlm("../x_FINAL2_17.txt")[:,1]
turbine_y = readdlm("../y_FINAL2_17.txt")[:,1]
# turbine_x = readdlm("../x_FINAL2_circle_37.txt")[:,1]
# turbine_y = readdlm("../y_FINAL2_circle_37.txt")[:,1]


t = time()
damage_no_loads = ff.get_total_farm_damage_super(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,turbine_ai,ct_model,
        nCycles,az_arr,turb_samples,omega_func,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=1.25)
println("time 1: ", time()-t)


t = time()

# damageOpt 40 turbs
xopt = [322.3804884475346, 132.0302336885437, 428.9569538669368, 324.77684138152784, 187.75277030505143, 244.28446686927725, 67.48444509232638, -31.471183079273644, 423.2152596157513, -9.326301720239682, 25.415027623050296, 176.27934145785403, -7.811199776857034, 251.1019754365447, -5.3850273169076734, 235.18161116027696, 368.8875965603199, 410.3693496118587, 446.49337193066634, 166.86602859996813, 435.16280644044434, 438.9366828892884, 412.50812882853114, 46.29855083632035, 395.16774586327887, 459.6517759535896, 341.8906822852894, 451.3616624034591, -39.649342897792074, 280.53218804861467, 223.4422019530111, 258.2058042488746, 164.220723423184, -37.88662331018175, 99.7918000800026, 103.50089696101699, 329.1406290571886, -11.257141008654216, -22.763121103739486, 8.220062894651225, 245.22667613404408, 225.80260070367808, 244.87667139825757, 354.20946298342545, 199.23197798490406, 87.79149056232814, 256.3510650187224, 258.0739684809345, 298.8708161676266, 120.38930799370044, 354.20946298342545, -0.5038541436463698, 151.39687551997062, 170.1282957171277, 43.74134105198326, -0.5038541436463678, 109.03444422776211, -0.50385414364637, 107.61001793073564, 354.20946298342545, 200.43972967061094, 157.22240225775718, 354.20946298342545, 207.6110938614384, 322.85075177602505, -0.5038541436463693, 34.379155334243364, 57.635758817973034, 354.20946298342545, 354.20946298342545, 354.20946298342545, 243.23742725142102, 73.85048741443175, 310.7853826628461, -0.5038541436463697, 354.20946298342545, -0.5038541436463699, 91.98860169010662, 208.08793797432259, -0.5038541436463713]

# xopt = [-48.40514993336536, 91.39206067401874, 97.92872295529035, 4.171432292093477, -83.19221527825631, 22.902546522334646, -5.059135848516813, -79.97689210464576, -39.82264960489544, -97.38069832967157, -73.07254144576682, 42.45135706488485, 91.80266093339196, -94.12225867470127, 1.1703554112535066, -5.183015420939314, 66.16024368815998, 58.10142426898922, 84.32842156761181, 22.94879504202222, 86.40998842031513, 37.526378674970935, 13.106090788178044, 9.380862502290734, -53.747558694833906, 44.61182882429593, -31.475869296002717, 27.94507205979449, -89.71509208442397, -18.076070243156835, 53.09199508559883, 82.47907689490017, -27.796891317286086, 6.993053617394247, 99.03670101482327, -98.88949716154694, 73.70594827909703, -80.21202650388751, -51.94672239612879, -96.34883215049784]

turbine_x = xopt[1:nturbines].*10.0
turbine_y = xopt[nturbines+1:end].*10.0

damage_with_loads = ff.get_total_farm_damage_super(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,turbine_ai,ct_model,
        nCycles,az_arr,turb_samples,omega_func,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=1.25)
println("time 2: ", time()-t)


figure(1,figsize=(6.5,3.5))
subplot(121)
plot(damage_no_loads,"o",color="C0",markersize=5)
ylim(0.0,0.55)
ylabel("damage")
xlabel("turbine number")
title("no damage constraints",fontsize=10)

subplot(122)
plot(damage_with_loads,"o",color="C1",markersize=5)
ylim(0.0,0.55)
xlabel("turbine number")
title("with damage constraints",fontsize=10)



# savefig("opt_damage_vals.pdf",transparent=true)
