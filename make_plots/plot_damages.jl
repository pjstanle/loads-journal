using FlowFarm
const ff = FlowFarm
using DelimitedFiles
using FLOWMath
using CCBlade
using PyPlot


include("../model_lowTI_NEW.jl")
nCycles = 50

# turbine_x = readdlm("../x_0.0325.txt")[:,1]
# turbine_y = readdlm("../y_0.0325.txt")[:,1]
# turbine_x = readdlm("../x_FINAL2_circle_37.txt")[:,1]
# turbine_y = readdlm("../y_FINAL2_circle_37.txt")[:,1]


# t = time()
# damage_no_loads = ff.get_total_farm_damage_super(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,turbine_ai,ct_model,
#         nCycles,az_arr,turb_samples,omega_func,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
#         Nlocs=Nlocs,fos=1.25)
# println("time 1: ", time()-t)


t = time()

# # damageOpt 40 turbs
# xopt = [322.3804884475346, 132.0302336885437, 428.9569538669368, 324.77684138152784, 187.75277030505143, 244.28446686927725, 67.48444509232638, -31.471183079273644, 423.2152596157513, -9.326301720239682, 25.415027623050296, 176.27934145785403, -7.811199776857034, 251.1019754365447, -5.3850273169076734, 235.18161116027696, 368.8875965603199, 410.3693496118587, 446.49337193066634, 166.86602859996813, 435.16280644044434, 438.9366828892884, 412.50812882853114, 46.29855083632035, 395.16774586327887, 459.6517759535896, 341.8906822852894, 451.3616624034591, -39.649342897792074, 280.53218804861467, 223.4422019530111, 258.2058042488746, 164.220723423184, -37.88662331018175, 99.7918000800026, 103.50089696101699, 329.1406290571886, -11.257141008654216, -22.763121103739486, 8.220062894651225, 245.22667613404408, 225.80260070367808, 244.87667139825757, 354.20946298342545, 199.23197798490406, 87.79149056232814, 256.3510650187224, 258.0739684809345, 298.8708161676266, 120.38930799370044, 354.20946298342545, -0.5038541436463698, 151.39687551997062, 170.1282957171277, 43.74134105198326, -0.5038541436463678, 109.03444422776211, -0.50385414364637, 107.61001793073564, 354.20946298342545, 200.43972967061094, 157.22240225775718, 354.20946298342545, 207.6110938614384, 322.85075177602505, -0.5038541436463693, 34.379155334243364, 57.635758817973034, 354.20946298342545, 354.20946298342545, 354.20946298342545, 243.23742725142102, 73.85048741443175, 310.7853826628461, -0.5038541436463697, 354.20946298342545, -0.5038541436463699, 91.98860169010662, 208.08793797432259, -0.5038541436463713]
#
# # xopt = [-48.40514993336536, 91.39206067401874, 97.92872295529035, 4.171432292093477, -83.19221527825631, 22.902546522334646, -5.059135848516813, -79.97689210464576, -39.82264960489544, -97.38069832967157, -73.07254144576682, 42.45135706488485, 91.80266093339196, -94.12225867470127, 1.1703554112535066, -5.183015420939314, 66.16024368815998, 58.10142426898922, 84.32842156761181, 22.94879504202222, 86.40998842031513, 37.526378674970935, 13.106090788178044, 9.380862502290734, -53.747558694833906, 44.61182882429593, -31.475869296002717, 27.94507205979449, -89.71509208442397, -18.076070243156835, 53.09199508559883, 82.47907689490017, -27.796891317286086, 6.993053617394247, 99.03670101482327, -98.88949716154694, 73.70594827909703, -80.21202650388751, -51.94672239612879, -96.34883215049784]
#
xopt = [65.9753750087778, 98.28659662875394, 158.96343637128854, 74.03352232991834, 134.4752567268328, 0.14566460378992702, 162.03873629493603, -28.783386361131267, 212.59203319161125, 32.61967603368509, 24.741779529873533, -12.31789332089469, 306.4584077273387, 288.85574485280176, -22.90203027430342, 48.52780293562848, 187.31203319161122, 200.74170855162657, 116.33809985744979, -5.2783260875086615, 8.34941119267549, 157.26605030048324, 122.82294256566261, 48.75352232991835, 234.8031485721828, 256.088533019794, 297.8507724137088, 281.17840772733865, 142.17025899640612, 260.2707984498679, 98.42823253963772, 184.2431485721828, 73.80780293562849, 237.71773951409673, -3.5033863611312652, 278.742248504532, 277.37393163384, 209.5231485721828, 287.9725167205617, 24.44959346685414, 169.63737270177916, 229.8427511815731, 236.0329507059336, -0.33592895027621594, 229.75476031119706, -0.3359289502762176, 0.3054145980655882, 236.1580520441989, -0.3359289502762194, 154.57199755773135, 227.59607128685795, 124.41671197017173, -0.33592895027621705, 97.49621955229864, 187.83485278025577, 236.1580520441989, -0.33592895027621483, 113.8314092338384, 212.14447829991522, 43.032573065441575, 147.4986199519627, 163.5263652502504, -0.3359289502762172, -0.33592895027621883, 236.15805204419888, 222.51946788189082, 46.56156995106145, -0.33592895027621805, 15.936845394795425, 13.87531371354598, 6.295575129934867, 236.15805204419888, 236.1580520441989, 2.4543629986525795, 236.15805204419888, 182.8865785051259, 236.1580520441989, 236.1580520441989, 151.55036759495204, 6.621108183365084]
turbine_x = xopt[1:nturbines].*10.0
turbine_y = xopt[nturbines+1:end].*10.0

# damage_with_loads = ff.get_total_farm_damage_super(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,turbine_ai,ct_model,
#         nCycles,az_arr,turb_samples,omega_func,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
#         Nlocs=Nlocs,fos=1.25)
div_sigma = 2.38512084848453
div_ti = 1.1841406781776536
fos = 2.0

damage = ff.get_total_farm_damage_FINAL(turbine_x,turbine_y,turbine_z,rotor_diameter,hub_height,turbine_yaw,ct_model,
        nCycles,az_arr,turb_samples,pitch_func,turbulence_func,r,sections,Rhub,Rtip,precone,tilt,windresource,model_set;
        Nlocs=Nlocs,fos=fos,rotor_sample_points_y=rotor_points_y,rotor_sample_points_z=rotor_points_z,div_sigma=div_sigma,div_ti=div_ti)
println("time 2: ", time()-t)


# figure(1,figsize=(6.5,3.5))
# subplot(121)
# plot(damage_no_loads,"o",color="C0",markersize=5)
# ylim(0.0,0.55)
# ylabel("damage")
# xlabel("turbine number")
# title("no damage constraints",fontsize=10)

# subplot(122)
plot(damage,"o",color="C1",markersize=5)
# ylim(0.0,0.55)
xlabel("turbine number")
title("with damage constraints",fontsize=10)



# savefig("opt_damage_vals.pdf",transparent=true)
